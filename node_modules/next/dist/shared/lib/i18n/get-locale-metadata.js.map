{"version":3,"sources":["../../../../shared/lib/i18n/get-locale-metadata.ts"],"sourcesContent":["import accept from '@hapi/accept'\nimport { denormalizePagePath } from '../../../server/denormalize-page-path'\nimport { detectDomainLocale } from './detect-domain-locale'\nimport { formatUrl } from '../router/utils/format-url'\nimport { normalizeLocalePath } from './normalize-locale-path'\nimport type { I18NConfig, DomainLocale } from '../../../server/config-shared'\n\ninterface Params {\n  cookies(): { [key: string]: string }\n  headers?: { [key: string]: string | string[] | undefined }\n  nextConfig: { basePath?: string; i18n: I18NConfig; trailingSlash?: boolean }\n  url: { hostname?: string | null; pathname: string }\n}\n\nexport function getLocaleMetadata(params: Params) {\n  const { i18n } = params.nextConfig\n  const { cookies, headers, nextConfig, url } = params\n  const path = normalizeLocalePath(url.pathname, i18n.locales)\n  const domain = detectDomainLocale(i18n.domains, getHostname(url, headers))\n  const defaultLocale = domain?.defaultLocale || i18n.defaultLocale\n  const preferredLocale = getAcceptPreferredLocale(i18n, headers)\n  return {\n    path,\n    domain,\n    defaultLocale,\n    locale: path?.detectedLocale || defaultLocale,\n    redirect: getRedirect({\n      locale: {\n        preferred: preferredLocale,\n        default: defaultLocale,\n        detected:\n          path?.detectedLocale ||\n          domain?.defaultLocale ||\n          getLocaleFromCookie(i18n, cookies) ||\n          preferredLocale ||\n          i18n.defaultLocale,\n      },\n      domain,\n      nextConfig,\n      url,\n    }),\n    trailingSlash:\n      url.pathname !== '/'\n        ? url.pathname.endsWith('/')\n        : nextConfig.trailingSlash,\n  }\n}\n\nfunction getLocaleFromCookie(\n  i18n: I18NConfig,\n  cookies: () => { [key: string]: string }\n) {\n  const nextLocale = cookies()?.NEXT_LOCALE?.toLowerCase()\n  return nextLocale\n    ? i18n.locales.find((locale) => nextLocale === locale.toLowerCase())\n    : undefined\n}\n\nfunction getAcceptPreferredLocale(\n  i18n: I18NConfig,\n  headers?: { [key: string]: string | string[] | undefined }\n) {\n  const value = headers?.['accept-language']\n  if (i18n.localeDetection !== false && value && !Array.isArray(value)) {\n    try {\n      return accept.language(value, i18n.locales)\n    } catch (err) {}\n  }\n}\n\nfunction getHostname(\n  parsed: { hostname?: string | null },\n  headers?: { [key: string]: string | string[] | undefined }\n) {\n  return ((!Array.isArray(headers?.host) && headers?.host) || parsed.hostname)\n    ?.split(':')[0]\n    .toLowerCase()\n}\n\nfunction getRedirect({\n  domain,\n  locale,\n  nextConfig,\n  url,\n}: {\n  domain?: DomainLocale\n  locale: { default: string; detected: string; preferred?: string }\n  nextConfig: { basePath?: string; i18n: I18NConfig; trailingSlash?: boolean }\n  url: { hostname?: string | null; pathname: string }\n}) {\n  const isRootPath = denormalizePagePath(url.pathname) === '/'\n  if (nextConfig.i18n.localeDetection !== false && isRootPath) {\n    const preferredDomain = detectDomainLocale(\n      nextConfig.i18n.domains,\n      undefined,\n      locale.preferred\n    )\n\n    if (domain && preferredDomain) {\n      const isPDomain = preferredDomain.domain === domain.domain\n      const isPLocale = preferredDomain.defaultLocale === locale.preferred\n      if (!isPDomain || !isPLocale) {\n        const scheme = `http${preferredDomain.http ? '' : 's'}`\n        const rlocale = isPLocale ? '' : locale.preferred\n        return `${scheme}://${preferredDomain.domain}/${rlocale}`\n      }\n    }\n\n    if (locale.detected.toLowerCase() !== locale.default.toLowerCase()) {\n      return formatUrl({\n        ...url,\n        pathname: `${nextConfig.basePath || ''}/${locale.detected}`,\n      })\n    }\n  }\n}\n"],"names":[],"mappings":"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"}