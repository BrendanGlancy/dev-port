{"version":3,"sources":["../../../build/output/index.ts"],"sourcesContent":["import chalk from 'chalk'\nimport stripAnsi from 'next/dist/compiled/strip-ansi'\nimport textTable from 'next/dist/compiled/text-table'\nimport createStore from 'next/dist/compiled/unistore'\nimport formatWebpackMessages from '../../client/dev/error-overlay/format-webpack-messages'\nimport { OutputState, store as consoleStore } from './store'\n\nexport function startedDevelopmentServer(appUrl: string, bindAddr: string) {\n  consoleStore.setState({ appUrl, bindAddr })\n}\n\nlet previousClient: import('webpack').Compiler | null = null\nlet previousServer: import('webpack').Compiler | null = null\n\ntype CompilerDiagnostics = {\n  errors: string[] | null\n  warnings: string[] | null\n}\n\ntype WebpackStatus =\n  | { loading: true }\n  | ({ loading: false } & CompilerDiagnostics)\n\ntype AmpStatus = {\n  message: string\n  line: number\n  col: number\n  specUrl: string | null\n  code: string\n}\n\nexport type AmpPageStatus = {\n  [page: string]: { errors: AmpStatus[]; warnings: AmpStatus[] }\n}\n\ntype BuildStatusStore = {\n  client: WebpackStatus\n  server: WebpackStatus\n  amp: AmpPageStatus\n}\n\n// eslint typescript has a bug with TS enums\n/* eslint-disable no-shadow */\nenum WebpackStatusPhase {\n  COMPILING = 1,\n  COMPILED_WITH_ERRORS = 2,\n  COMPILED_WITH_WARNINGS = 4,\n  COMPILED = 5,\n}\n\nfunction getWebpackStatusPhase(status: WebpackStatus): WebpackStatusPhase {\n  if (status.loading) {\n    return WebpackStatusPhase.COMPILING\n  }\n  if (status.errors) {\n    return WebpackStatusPhase.COMPILED_WITH_ERRORS\n  }\n  if (status.warnings) {\n    return WebpackStatusPhase.COMPILED_WITH_WARNINGS\n  }\n  return WebpackStatusPhase.COMPILED\n}\n\nexport function formatAmpMessages(amp: AmpPageStatus) {\n  let output = chalk.bold('Amp Validation') + '\\n\\n'\n  let messages: string[][] = []\n\n  const chalkError = chalk.red('error')\n  function ampError(page: string, error: AmpStatus) {\n    messages.push([page, chalkError, error.message, error.specUrl || ''])\n  }\n\n  const chalkWarn = chalk.yellow('warn')\n  function ampWarn(page: string, warn: AmpStatus) {\n    messages.push([page, chalkWarn, warn.message, warn.specUrl || ''])\n  }\n\n  for (const page in amp) {\n    let { errors, warnings } = amp[page]\n\n    const devOnlyFilter = (err: AmpStatus) => err.code !== 'DEV_MODE_ONLY'\n    errors = errors.filter(devOnlyFilter)\n    warnings = warnings.filter(devOnlyFilter)\n    if (!(errors.length || warnings.length)) {\n      // Skip page with no non-dev warnings\n      continue\n    }\n\n    if (errors.length) {\n      ampError(page, errors[0])\n      for (let index = 1; index < errors.length; ++index) {\n        ampError('', errors[index])\n      }\n    }\n    if (warnings.length) {\n      ampWarn(errors.length ? '' : page, warnings[0])\n      for (let index = 1; index < warnings.length; ++index) {\n        ampWarn('', warnings[index])\n      }\n    }\n    messages.push(['', '', '', ''])\n  }\n\n  if (!messages.length) {\n    return ''\n  }\n\n  output += textTable(messages, {\n    align: ['l', 'l', 'l', 'l'],\n    stringLength(str: string) {\n      return stripAnsi(str).length\n    },\n  })\n\n  return output\n}\n\nconst buildStore = createStore<BuildStatusStore>()\n\nbuildStore.subscribe((state) => {\n  const { amp, client, server } = state\n\n  const [{ status }] = [\n    { status: client, phase: getWebpackStatusPhase(client) },\n    { status: server, phase: getWebpackStatusPhase(server) },\n  ].sort((a, b) => a.phase.valueOf() - b.phase.valueOf())\n\n  const { bootstrap: bootstrapping, appUrl } = consoleStore.getState()\n  if (bootstrapping && status.loading) {\n    return\n  }\n\n  let partialState: Partial<OutputState> = {\n    bootstrap: false,\n    appUrl: appUrl!,\n  }\n\n  if (status.loading) {\n    consoleStore.setState(\n      { ...partialState, loading: true } as OutputState,\n      true\n    )\n  } else {\n    let { errors, warnings } = status\n\n    if (errors == null) {\n      if (Object.keys(amp).length > 0) {\n        warnings = (warnings || []).concat(formatAmpMessages(amp) || [])\n        if (!warnings.length) warnings = null\n      }\n    }\n\n    consoleStore.setState(\n      {\n        ...partialState,\n        loading: false,\n        typeChecking: false,\n        errors,\n        warnings,\n      } as OutputState,\n      true\n    )\n  }\n})\n\nexport function ampValidation(\n  page: string,\n  errors: AmpStatus[],\n  warnings: AmpStatus[]\n) {\n  const { amp } = buildStore.getState()\n  if (!(errors.length || warnings.length)) {\n    buildStore.setState({\n      amp: Object.keys(amp)\n        .filter((k) => k !== page)\n        .sort()\n        // eslint-disable-next-line no-sequences\n        .reduce((a, c) => ((a[c] = amp[c]), a), {} as AmpPageStatus),\n    })\n    return\n  }\n\n  const newAmp: AmpPageStatus = { ...amp, [page]: { errors, warnings } }\n  buildStore.setState({\n    amp: Object.keys(newAmp)\n      .sort()\n      // eslint-disable-next-line no-sequences\n      .reduce((a, c) => ((a[c] = newAmp[c]), a), {} as AmpPageStatus),\n  })\n}\n\nexport function watchCompilers(\n  client: import('webpack').Compiler,\n  server: import('webpack').Compiler\n) {\n  if (previousClient === client && previousServer === server) {\n    return\n  }\n\n  buildStore.setState({\n    client: { loading: true },\n    server: { loading: true },\n  })\n\n  function tapCompiler(\n    key: string,\n    compiler: any,\n    onEvent: (status: WebpackStatus) => void\n  ) {\n    compiler.hooks.invalid.tap(`NextJsInvalid-${key}`, () => {\n      onEvent({ loading: true })\n    })\n\n    compiler.hooks.done.tap(\n      `NextJsDone-${key}`,\n      (stats: import('webpack').Stats) => {\n        buildStore.setState({ amp: {} })\n\n        const { errors, warnings } = formatWebpackMessages(\n          stats.toJson({ all: false, warnings: true, errors: true })\n        )\n\n        const hasErrors = !!errors?.length\n        const hasWarnings = !!warnings?.length\n\n        onEvent({\n          loading: false,\n          errors: hasErrors ? errors : null,\n          warnings: hasWarnings ? warnings : null,\n        })\n      }\n    )\n  }\n\n  tapCompiler('client', client, (status) =>\n    buildStore.setState({ client: status })\n  )\n  tapCompiler('server', server, (status) =>\n    buildStore.setState({ server: status })\n  )\n\n  previousClient = client\n  previousServer = server\n}\n"],"names":[],"mappings":"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"}