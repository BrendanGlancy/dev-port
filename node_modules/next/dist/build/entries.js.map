{"version":3,"sources":["../../build/entries.ts"],"sourcesContent":["import chalk from 'chalk'\nimport { posix, join } from 'path'\nimport { stringify } from 'querystring'\nimport { API_ROUTE, DOT_NEXT_ALIAS, PAGES_DIR_ALIAS } from '../lib/constants'\nimport { __ApiPreviewProps } from '../server/api-utils'\nimport { isTargetLikeServerless } from '../server/config'\nimport { normalizePagePath } from '../server/normalize-page-path'\nimport { warn } from './output/log'\nimport { ClientPagesLoaderOptions } from './webpack/loaders/next-client-pages-loader'\nimport { ServerlessLoaderQuery } from './webpack/loaders/next-serverless-loader'\nimport { LoadedEnvFiles } from '@next/env'\nimport { NextConfigComplete } from '../server/config-shared'\n\ntype PagesMapping = {\n  [page: string]: string\n}\n\nexport function createPagesMapping(\n  pagePaths: string[],\n  extensions: string[],\n  isWebpack5: boolean,\n  isDev: boolean\n): PagesMapping {\n  const previousPages: PagesMapping = {}\n  const pages: PagesMapping = pagePaths.reduce(\n    (result: PagesMapping, pagePath): PagesMapping => {\n      let page = `${pagePath\n        .replace(new RegExp(`\\\\.+(${extensions.join('|')})$`), '')\n        .replace(/\\\\/g, '/')}`.replace(/\\/index$/, '')\n\n      const pageKey = page === '' ? '/' : page\n\n      if (pageKey in result) {\n        warn(\n          `Duplicate page detected. ${chalk.cyan(\n            join('pages', previousPages[pageKey])\n          )} and ${chalk.cyan(\n            join('pages', pagePath)\n          )} both resolve to ${chalk.cyan(pageKey)}.`\n        )\n      } else {\n        previousPages[pageKey] = pagePath\n      }\n      result[pageKey] = join(PAGES_DIR_ALIAS, pagePath).replace(/\\\\/g, '/')\n      return result\n    },\n    {}\n  )\n\n  // we alias these in development and allow webpack to\n  // allow falling back to the correct source file so\n  // that HMR can work properly when a file is added/removed\n  if (isWebpack5 && isDev) {\n    pages['/_app'] = `${PAGES_DIR_ALIAS}/_app`\n    pages['/_error'] = `${PAGES_DIR_ALIAS}/_error`\n    pages['/_document'] = `${PAGES_DIR_ALIAS}/_document`\n  } else {\n    pages['/_app'] = pages['/_app'] || 'next/dist/pages/_app'\n    pages['/_error'] = pages['/_error'] || 'next/dist/pages/_error'\n    pages['/_document'] = pages['/_document'] || 'next/dist/pages/_document'\n  }\n  return pages\n}\n\nexport type WebpackEntrypoints = {\n  [bundle: string]:\n    | string\n    | string[]\n    | {\n        import: string | string[]\n        dependOn?: string | string[]\n      }\n}\n\ntype Entrypoints = {\n  client: WebpackEntrypoints\n  server: WebpackEntrypoints\n}\n\nexport function createEntrypoints(\n  pages: PagesMapping,\n  target: 'server' | 'serverless' | 'experimental-serverless-trace',\n  buildId: string,\n  previewMode: __ApiPreviewProps,\n  config: NextConfigComplete,\n  loadedEnvFiles: LoadedEnvFiles\n): Entrypoints {\n  const client: WebpackEntrypoints = {}\n  const server: WebpackEntrypoints = {}\n\n  const hasRuntimeConfig =\n    Object.keys(config.publicRuntimeConfig).length > 0 ||\n    Object.keys(config.serverRuntimeConfig).length > 0\n\n  const defaultServerlessOptions = {\n    absoluteAppPath: pages['/_app'],\n    absoluteDocumentPath: pages['/_document'],\n    absoluteErrorPath: pages['/_error'],\n    absolute404Path: pages['/404'] || '',\n    distDir: DOT_NEXT_ALIAS,\n    buildId,\n    assetPrefix: config.assetPrefix,\n    generateEtags: config.generateEtags ? 'true' : '',\n    poweredByHeader: config.poweredByHeader ? 'true' : '',\n    canonicalBase: config.amp.canonicalBase || '',\n    basePath: config.basePath,\n    runtimeConfig: hasRuntimeConfig\n      ? JSON.stringify({\n          publicRuntimeConfig: config.publicRuntimeConfig,\n          serverRuntimeConfig: config.serverRuntimeConfig,\n        })\n      : '',\n    previewProps: JSON.stringify(previewMode),\n    // base64 encode to make sure contents don't break webpack URL loading\n    loadedEnvFiles: Buffer.from(JSON.stringify(loadedEnvFiles)).toString(\n      'base64'\n    ),\n    i18n: config.i18n ? JSON.stringify(config.i18n) : '',\n  }\n\n  Object.keys(pages).forEach((page) => {\n    const absolutePagePath = pages[page]\n    const bundleFile = normalizePagePath(page)\n    const isApiRoute = page.match(API_ROUTE)\n\n    const clientBundlePath = posix.join('pages', bundleFile)\n    const serverBundlePath = posix.join('pages', bundleFile)\n\n    const isLikeServerless = isTargetLikeServerless(target)\n\n    if (isApiRoute && isLikeServerless) {\n      const serverlessLoaderOptions: ServerlessLoaderQuery = {\n        page,\n        absolutePagePath,\n        ...defaultServerlessOptions,\n      }\n      server[serverBundlePath] = `next-serverless-loader?${stringify(\n        serverlessLoaderOptions\n      )}!`\n    } else if (isApiRoute || target === 'server') {\n      server[serverBundlePath] = [absolutePagePath]\n    } else if (isLikeServerless && page !== '/_app' && page !== '/_document') {\n      const serverlessLoaderOptions: ServerlessLoaderQuery = {\n        page,\n        absolutePagePath,\n        ...defaultServerlessOptions,\n      }\n      server[serverBundlePath] = `next-serverless-loader?${stringify(\n        serverlessLoaderOptions\n      )}!`\n    }\n\n    if (page === '/_document') {\n      return\n    }\n\n    if (!isApiRoute) {\n      const pageLoaderOpts: ClientPagesLoaderOptions = {\n        page,\n        absolutePagePath,\n      }\n      const pageLoader = `next-client-pages-loader?${stringify(\n        pageLoaderOpts\n      )}!`\n\n      // Make sure next/router is a dependency of _app or else chunk splitting\n      // might cause the router to not be able to load causing hydration\n      // to fail\n\n      client[clientBundlePath] =\n        page === '/_app'\n          ? [pageLoader, require.resolve('../client/router')]\n          : pageLoader\n    }\n  })\n\n  return {\n    client,\n    server,\n  }\n}\n"],"names":[],"mappings":"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"}