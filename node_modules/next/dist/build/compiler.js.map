{"version":3,"sources":["../../build/compiler.ts"],"sourcesContent":["import { webpack } from 'next/dist/compiled/webpack/webpack'\nimport { Span } from '../telemetry/trace'\n\nexport type CompilerResult = {\n  errors: string[]\n  warnings: string[]\n}\n\nfunction generateStats(\n  result: CompilerResult,\n  stat: webpack.Stats\n): CompilerResult {\n  const { errors, warnings } = stat.toJson('errors-warnings')\n  if (errors.length > 0) {\n    result.errors.push(...errors)\n  }\n\n  if (warnings.length > 0) {\n    result.warnings.push(...warnings)\n  }\n\n  return result\n}\n\n// Webpack 5 requires the compiler to be closed (to save caches)\n// Webpack 4 does not have this close method so in order to be backwards compatible we check if it exists\nfunction closeCompiler(compiler: webpack.Compiler | webpack.MultiCompiler) {\n  return new Promise<void>((resolve, reject) => {\n    if ('close' in compiler) {\n      // @ts-ignore Close only exists on the compiler in webpack 5\n      return compiler.close((err: any) => (err ? reject(err) : resolve()))\n    }\n\n    resolve()\n  })\n}\n\nexport function runCompiler(\n  config: webpack.Configuration,\n  { runWebpackSpan }: { runWebpackSpan: Span }\n): Promise<CompilerResult> {\n  return new Promise((resolve, reject) => {\n    const compiler = webpack(config)\n    compiler.run((err: Error, stats: webpack.Stats) => {\n      const webpackCloseSpan = runWebpackSpan.traceChild('webpack-close')\n      webpackCloseSpan\n        .traceAsyncFn(() => closeCompiler(compiler))\n        .then(() => {\n          if (err) {\n            const reason = err?.toString()\n            if (reason) {\n              return resolve({ errors: [reason], warnings: [] })\n            }\n            return reject(err)\n          }\n\n          const result = webpackCloseSpan\n            .traceChild('webpack-generate-error-stats')\n            .traceFn(() => generateStats({ errors: [], warnings: [] }, stats))\n          return resolve(result)\n        })\n    })\n  })\n}\n"],"names":[],"mappings":";;;;QAqCgB,WAAW,GAAX,WAAW;AArCH,GAAoC,CAApC,QAAoC;SAQnD,aAAa,CACpB,MAAsB,EACtB,IAAmB,EACH,CAAC;IACjB,KAAK,GAAG,MAAM,GAAE,QAAQ,MAAK,IAAI,CAAC,MAAM,EAAC,eAAiB;IAC1D,EAAE,EAAE,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;QACtB,MAAM,CAAC,MAAM,CAAC,IAAI,IAAI,MAAM;IAC9B,CAAC;IAED,EAAE,EAAE,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;QACxB,MAAM,CAAC,QAAQ,CAAC,IAAI,IAAI,QAAQ;IAClC,CAAC;WAEM,MAAM;AACf,CAAC;AAED,EAAgE,AAAhE,8DAAgE;AAChE,EAAyG,AAAzG,uGAAyG;SAChG,aAAa,CAAC,QAAkD,EAAE,CAAC;WACnE,GAAG,CAAC,OAAO,EAAQ,OAAO,EAAE,MAAM,GAAK,CAAC;QAC7C,EAAE,GAAE,KAAO,KAAI,QAAQ,EAAE,CAAC;YACxB,EAA4D,AAA5D,0DAA4D;mBACrD,QAAQ,CAAC,KAAK,EAAE,GAAQ,GAAM,GAAG,GAAG,MAAM,CAAC,GAAG,IAAI,OAAO;;QAClE,CAAC;QAED,OAAO;IACT,CAAC;AACH,CAAC;SAEe,WAAW,CACzB,MAA6B,IAC3B,cAAc,KACS,CAAC;WACnB,GAAG,CAAC,OAAO,EAAE,OAAO,EAAE,MAAM,GAAK,CAAC;QACvC,KAAK,CAAC,QAAQ,OA1CM,QAAoC,UA0C/B,MAAM;QAC/B,QAAQ,CAAC,GAAG,EAAE,GAAU,EAAE,KAAoB,GAAK,CAAC;YAClD,KAAK,CAAC,gBAAgB,GAAG,cAAc,CAAC,UAAU,EAAC,aAAe;YAClE,gBAAgB,CACb,YAAY,KAAO,aAAa,CAAC,QAAQ;cACzC,IAAI,KAAO,CAAC;gBACX,EAAE,EAAE,GAAG,EAAE,CAAC;oBACR,KAAK,CAAC,MAAM,GAAG,GAAG,aAAH,GAAG,UAAH,CAAa,QAAb,CAAa,GAAb,GAAG,CAAE,QAAQ;oBAC5B,EAAE,EAAE,MAAM,EAAE,CAAC;+BACJ,OAAO;4BAAG,MAAM;gCAAG,MAAM;;4BAAG,QAAQ;;oBAC7C,CAAC;2BACM,MAAM,CAAC,GAAG;gBACnB,CAAC;gBAED,KAAK,CAAC,MAAM,GAAG,gBAAgB,CAC5B,UAAU,EAAC,4BAA8B,GACzC,OAAO,KAAO,aAAa;wBAAG,MAAM;wBAAM,QAAQ;uBAAQ,KAAK;;uBAC3D,OAAO,CAAC,MAAM;YACvB,CAAC;QACL,CAAC;IACH,CAAC;AACH,CAAC"}