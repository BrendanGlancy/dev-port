{"version":3,"sources":["../../../../build/webpack/plugins/build-manifest-plugin.ts"],"sourcesContent":["import devalue from 'next/dist/compiled/devalue'\nimport {\n  webpack,\n  isWebpack5,\n  sources,\n} from 'next/dist/compiled/webpack/webpack'\nimport {\n  BUILD_MANIFEST,\n  CLIENT_STATIC_FILES_PATH,\n  CLIENT_STATIC_FILES_RUNTIME_MAIN,\n  CLIENT_STATIC_FILES_RUNTIME_POLYFILLS_SYMBOL,\n  CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH,\n  CLIENT_STATIC_FILES_RUNTIME_AMP,\n} from '../../../shared/lib/constants'\nimport { BuildManifest } from '../../../server/get-page-files'\nimport getRouteFromEntrypoint from '../../../server/get-route-from-entrypoint'\nimport { ampFirstEntryNamesMap } from './next-drop-client-page-plugin'\nimport { Rewrite } from '../../../lib/load-custom-routes'\nimport { getSortedRoutes } from '../../../shared/lib/router/utils'\nimport { spans } from './profiling-plugin'\nimport { CustomRoutes } from '../../../lib/load-custom-routes'\n\ntype DeepMutable<T> = { -readonly [P in keyof T]: DeepMutable<T[P]> }\n\nexport type ClientBuildManifest = Record<string, string[]>\n\n// This function takes the asset map generated in BuildManifestPlugin and creates a\n// reduced version to send to the client.\nfunction generateClientManifest(\n  compiler: any,\n  assetMap: BuildManifest,\n  rewrites: CustomRoutes['rewrites']\n): string {\n  const compilerSpan = spans.get(compiler)\n  const genClientManifestSpan = compilerSpan?.traceChild(\n    'NextJsBuildManifest-generateClientManifest'\n  )\n\n  return genClientManifestSpan?.traceFn(() => {\n    const clientManifest: ClientBuildManifest = {\n      // TODO: update manifest type to include rewrites\n      __rewrites: rewrites as any,\n    }\n    const appDependencies = new Set(assetMap.pages['/_app'])\n    const sortedPageKeys = getSortedRoutes(Object.keys(assetMap.pages))\n\n    sortedPageKeys.forEach((page) => {\n      const dependencies = assetMap.pages[page]\n\n      if (page === '/_app') return\n      // Filter out dependencies in the _app entry, because those will have already\n      // been loaded by the client prior to a navigation event\n      const filteredDeps = dependencies.filter(\n        (dep) => !appDependencies.has(dep)\n      )\n\n      // The manifest can omit the page if it has no requirements\n      if (filteredDeps.length) {\n        clientManifest[page] = filteredDeps\n      }\n    })\n    // provide the sorted pages as an array so we don't rely on the object's keys\n    // being in order and we don't slow down look-up time for page assets\n    clientManifest.sortedPages = sortedPageKeys\n\n    return devalue(clientManifest)\n  })\n}\n\nfunction getEntrypointFiles(entrypoint: any): string[] {\n  return (\n    entrypoint\n      ?.getFiles()\n      .filter((file: string) => {\n        // We don't want to include `.hot-update.js` files into the initial page\n        return /(?<!\\.hot-update)\\.(js|css)($|\\?)/.test(file)\n      })\n      .map((file: string) => file.replace(/\\\\/g, '/')) ?? []\n  )\n}\n\nconst processRoute = (r: Rewrite) => {\n  const rewrite = { ...r }\n\n  // omit external rewrite destinations since these aren't\n  // handled client-side\n  if (!rewrite.destination.startsWith('/')) {\n    delete (rewrite as any).destination\n  }\n  return rewrite\n}\n\n// This plugin creates a build-manifest.json for all assets that are being output\n// It has a mapping of \"entry\" filename to real filename. Because the real filename can be hashed in production\nexport default class BuildManifestPlugin {\n  private buildId: string\n  private rewrites: CustomRoutes['rewrites']\n  private isDevFallback: boolean\n\n  constructor(options: {\n    buildId: string\n    rewrites: CustomRoutes['rewrites']\n    isDevFallback?: boolean\n  }) {\n    this.buildId = options.buildId\n    this.isDevFallback = !!options.isDevFallback\n    this.rewrites = {\n      beforeFiles: [],\n      afterFiles: [],\n      fallback: [],\n    }\n    this.rewrites.beforeFiles = options.rewrites.beforeFiles.map(processRoute)\n    this.rewrites.afterFiles = options.rewrites.afterFiles.map(processRoute)\n    this.rewrites.fallback = options.rewrites.fallback.map(processRoute)\n  }\n\n  createAssets(compiler: any, compilation: any, assets: any) {\n    const compilerSpan = spans.get(compiler)\n    const createAssetsSpan = compilerSpan?.traceChild(\n      'NextJsBuildManifest-createassets'\n    )\n    return createAssetsSpan?.traceFn(() => {\n      const entrypoints: Map<string, any> = compilation.entrypoints\n      const assetMap: DeepMutable<BuildManifest> = {\n        polyfillFiles: [],\n        devFiles: [],\n        ampDevFiles: [],\n        lowPriorityFiles: [],\n        pages: { '/_app': [] },\n        ampFirstPages: [],\n      }\n\n      const ampFirstEntryNames = ampFirstEntryNamesMap.get(compilation)\n      if (ampFirstEntryNames) {\n        for (const entryName of ampFirstEntryNames) {\n          const pagePath = getRouteFromEntrypoint(entryName)\n          if (!pagePath) {\n            continue\n          }\n\n          assetMap.ampFirstPages.push(pagePath)\n        }\n      }\n\n      const mainFiles = new Set(\n        getEntrypointFiles(entrypoints.get(CLIENT_STATIC_FILES_RUNTIME_MAIN))\n      )\n\n      const compilationAssets: {\n        name: string\n        source: typeof sources.RawSource\n        info: object\n      }[] = compilation.getAssets()\n\n      assetMap.polyfillFiles = compilationAssets\n        .filter((p) => {\n          // Ensure only .js files are passed through\n          if (!p.name.endsWith('.js')) {\n            return false\n          }\n\n          return (\n            p.info && CLIENT_STATIC_FILES_RUNTIME_POLYFILLS_SYMBOL in p.info\n          )\n        })\n        .map((v) => v.name)\n\n      assetMap.devFiles = getEntrypointFiles(\n        entrypoints.get(CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH)\n      ).filter((file) => !mainFiles.has(file))\n\n      assetMap.ampDevFiles = getEntrypointFiles(\n        entrypoints.get(CLIENT_STATIC_FILES_RUNTIME_AMP)\n      )\n\n      const systemEntrypoints = new Set([\n        CLIENT_STATIC_FILES_RUNTIME_MAIN,\n        CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH,\n        CLIENT_STATIC_FILES_RUNTIME_AMP,\n      ])\n\n      for (const entrypoint of compilation.entrypoints.values()) {\n        if (systemEntrypoints.has(entrypoint.name)) continue\n        const pagePath = getRouteFromEntrypoint(entrypoint.name)\n\n        if (!pagePath) {\n          continue\n        }\n\n        const filesForPage = getEntrypointFiles(entrypoint)\n\n        assetMap.pages[pagePath] = [...new Set([...mainFiles, ...filesForPage])]\n      }\n\n      if (!this.isDevFallback) {\n        // Add the runtime build manifest file (generated later in this file)\n        // as a dependency for the app. If the flag is false, the file won't be\n        // downloaded by the client.\n        assetMap.lowPriorityFiles.push(\n          `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.js`\n        )\n        // Add the runtime ssg manifest file as a lazy-loaded file dependency.\n        // We also stub this file out for development mode (when it is not\n        // generated).\n        const srcEmptySsgManifest = `self.__SSG_MANIFEST=new Set;self.__SSG_MANIFEST_CB&&self.__SSG_MANIFEST_CB()`\n\n        const ssgManifestPath = `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_ssgManifest.js`\n        assetMap.lowPriorityFiles.push(ssgManifestPath)\n        assets[ssgManifestPath] = new sources.RawSource(srcEmptySsgManifest)\n      }\n\n      assetMap.pages = Object.keys(assetMap.pages)\n        .sort()\n        // eslint-disable-next-line\n        .reduce((a, c) => ((a[c] = assetMap.pages[c]), a), {} as any)\n\n      let buildManifestName = BUILD_MANIFEST\n\n      if (this.isDevFallback) {\n        buildManifestName = `fallback-${BUILD_MANIFEST}`\n      }\n\n      assets[buildManifestName] = new sources.RawSource(\n        JSON.stringify(assetMap, null, 2)\n      )\n\n      if (!this.isDevFallback) {\n        const clientManifestPath = `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.js`\n\n        assets[clientManifestPath] = new sources.RawSource(\n          `self.__BUILD_MANIFEST = ${generateClientManifest(\n            compiler,\n            assetMap,\n            this.rewrites\n          )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n        )\n      }\n\n      return assets\n    })\n  }\n\n  apply(compiler: webpack.Compiler) {\n    if (isWebpack5) {\n      compiler.hooks.make.tap('NextJsBuildManifest', (compilation) => {\n        // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n        compilation.hooks.processAssets.tap(\n          {\n            name: 'NextJsBuildManifest',\n            // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n            stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n          },\n          (assets: any) => {\n            this.createAssets(compiler, compilation, assets)\n          }\n        )\n      })\n      return\n    }\n\n    compiler.hooks.emit.tap('NextJsBuildManifest', (compilation: any) => {\n      this.createAssets(compiler, compilation, compilation.assets)\n    })\n  }\n}\n"],"names":[],"mappings":"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"}