{"version":3,"sources":["../../../../build/webpack/plugins/font-stylesheet-gathering-plugin.ts"],"sourcesContent":["import {\n  webpack,\n  BasicEvaluatedExpression,\n  isWebpack5,\n  sources,\n} from 'next/dist/compiled/webpack/webpack'\nimport { namedTypes } from 'ast-types'\nimport {\n  getFontDefinitionFromNetwork,\n  FontManifest,\n} from '../../../server/font-utils'\nimport postcss from 'postcss'\nimport minifier from 'cssnano-simple'\nimport {\n  FONT_MANIFEST,\n  OPTIMIZED_FONT_PROVIDERS,\n} from '../../../shared/lib/constants'\n\nfunction minifyCss(css: string): Promise<string> {\n  return postcss([\n    minifier(\n      {\n        excludeAll: true,\n        discardComments: true,\n        normalizeWhitespace: { exclude: false },\n      },\n      postcss\n    ),\n  ])\n    .process(css, { from: undefined })\n    .then((res) => res.css)\n}\n\nexport class FontStylesheetGatheringPlugin {\n  compiler?: webpack.Compiler\n  gatheredStylesheets: Array<string> = []\n  manifestContent: FontManifest = []\n  isLikeServerless: boolean\n\n  constructor({ isLikeServerless }: { isLikeServerless: boolean }) {\n    this.isLikeServerless = isLikeServerless\n  }\n\n  private parserHandler = (\n    factory: webpack.compilation.NormalModuleFactory\n  ): void => {\n    const JS_TYPES = ['auto', 'esm', 'dynamic']\n    // Do an extra walk per module and add interested visitors to the walk.\n    for (const type of JS_TYPES) {\n      factory.hooks.parser\n        .for('javascript/' + type)\n        .tap(this.constructor.name, (parser: any) => {\n          /**\n           * Webpack fun facts:\n           * `parser.hooks.call.for` cannot catch calls for user defined identifiers like `__jsx`\n           * it can only detect calls for native objects like `window`, `this`, `eval` etc.\n           * In order to be able to catch calls of variables like `__jsx`, first we need to catch them as\n           * Identifier and then return `BasicEvaluatedExpression` whose `id` and `type` webpack matches to\n           * invoke hook for call.\n           * See: https://github.com/webpack/webpack/blob/webpack-4/lib/Parser.js#L1931-L1932.\n           */\n          parser.hooks.evaluate\n            .for('Identifier')\n            .tap(this.constructor.name, (node: namedTypes.Identifier) => {\n              // We will only optimize fonts from first party code.\n              if (parser?.state?.module?.resource.includes('node_modules')) {\n                return\n              }\n              let result\n              if (node.name === '_jsx' || node.name === '__jsx') {\n                result = new BasicEvaluatedExpression()\n                // @ts-ignore\n                result.setRange(node.range)\n                result.setExpression(node)\n                result.setIdentifier(node.name)\n\n                // This was added webpack 5.\n                if (isWebpack5) {\n                  result.getMembers = () => []\n                }\n              }\n              return result\n            })\n\n          const jsxNodeHandler = (node: namedTypes.CallExpression) => {\n            if (node.arguments.length !== 2) {\n              // A font link tag has only two arguments rel=stylesheet and href='...'\n              return\n            }\n            if (!isNodeCreatingLinkElement(node)) {\n              return\n            }\n\n            // node.arguments[0] is the name of the tag and [1] are the props.\n            const arg1 = node.arguments[1]\n\n            const propsNode =\n              arg1.type === 'ObjectExpression'\n                ? (arg1 as namedTypes.ObjectExpression)\n                : undefined\n            const props: { [key: string]: string } = {}\n            if (propsNode) {\n              propsNode.properties.forEach((prop) => {\n                if (prop.type !== 'Property') {\n                  return\n                }\n                if (\n                  prop.key.type === 'Identifier' &&\n                  prop.value.type === 'Literal'\n                ) {\n                  props[prop.key.name] = prop.value.value as string\n                }\n              })\n            }\n\n            if (\n              !props.rel ||\n              props.rel !== 'stylesheet' ||\n              !props.href ||\n              !OPTIMIZED_FONT_PROVIDERS.some(({ url }) =>\n                props.href.startsWith(url)\n              )\n            ) {\n              return false\n            }\n\n            this.gatheredStylesheets.push(props.href)\n\n            if (isWebpack5) {\n              const buildInfo = parser?.state?.module?.buildInfo\n\n              if (buildInfo) {\n                buildInfo.valueDependencies.set(\n                  FONT_MANIFEST,\n                  this.gatheredStylesheets\n                )\n              }\n            }\n          }\n\n          // React JSX transform:\n          parser.hooks.call\n            .for('_jsx')\n            .tap(this.constructor.name, jsxNodeHandler)\n          // Next.js JSX transform:\n          parser.hooks.call\n            .for('__jsx')\n            .tap(this.constructor.name, jsxNodeHandler)\n          // New React JSX transform:\n          parser.hooks.call\n            .for('imported var')\n            .tap(this.constructor.name, jsxNodeHandler)\n        })\n    }\n  }\n\n  public apply(compiler: webpack.Compiler) {\n    this.compiler = compiler\n    compiler.hooks.normalModuleFactory.tap(\n      this.constructor.name,\n      this.parserHandler\n    )\n    compiler.hooks.make.tapAsync(this.constructor.name, (compilation, cb) => {\n      if (this.isLikeServerless) {\n        /**\n         * Inline font manifest for serverless case only.\n         * For target: server drive the manifest through physical file and less of webpack magic.\n         */\n        const mainTemplate = compilation.mainTemplate\n        mainTemplate.hooks.requireExtensions.tap(\n          this.constructor.name,\n          (source: string) => {\n            return `${source}\n                // Font manifest declaration\n                ${\n                  isWebpack5 ? '__webpack_require__' : mainTemplate.requireFn\n                }.__NEXT_FONT_MANIFEST__ = ${JSON.stringify(\n              this.manifestContent\n            )};\n            // Enable feature:\n            process.env.__NEXT_OPTIMIZE_FONTS = JSON.stringify(true);`\n          }\n        )\n      }\n      compilation.hooks.finishModules.tapAsync(\n        this.constructor.name,\n        async (modules: any, modulesFinished: Function) => {\n          let fontStylesheets = this.gatheredStylesheets\n\n          if (isWebpack5) {\n            const fontUrls = new Set<string>()\n            modules.forEach((module: any) => {\n              const fontDependencies =\n                module?.buildInfo?.valueDependencies?.get(FONT_MANIFEST)\n              if (fontDependencies) {\n                fontDependencies.forEach((v: string) => fontUrls.add(v))\n              }\n            })\n\n            fontStylesheets = Array.from(fontUrls)\n          }\n\n          const fontDefinitionPromises = fontStylesheets.map((url) =>\n            getFontDefinitionFromNetwork(url)\n          )\n\n          this.manifestContent = []\n          for (let promiseIndex in fontDefinitionPromises) {\n            const css = await fontDefinitionPromises[promiseIndex]\n\n            if (css) {\n              const content = await minifyCss(css)\n              this.manifestContent.push({\n                url: fontStylesheets[promiseIndex],\n                content,\n              })\n            }\n          }\n          if (!isWebpack5) {\n            compilation.assets[FONT_MANIFEST] = new sources.RawSource(\n              JSON.stringify(this.manifestContent, null, '  ')\n            )\n          }\n          modulesFinished()\n        }\n      )\n      cb()\n    })\n\n    if (isWebpack5) {\n      compiler.hooks.make.tap(this.constructor.name, (compilation) => {\n        // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n        compilation.hooks.processAssets.tap(\n          {\n            name: this.constructor.name,\n            // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n            stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n          },\n          (assets: any) => {\n            assets['../' + FONT_MANIFEST] = new sources.RawSource(\n              JSON.stringify(this.manifestContent, null, '  ')\n            )\n          }\n        )\n      })\n    }\n  }\n}\n\nfunction isNodeCreatingLinkElement(node: namedTypes.CallExpression) {\n  const callee = node.callee as namedTypes.Identifier\n  if (callee.type !== 'Identifier') {\n    return false\n  }\n  const componentNode = node.arguments[0] as namedTypes.Literal\n  if (componentNode.type !== 'Literal') {\n    return false\n  }\n  // React has pragma: _jsx.\n  // Next has pragma: __jsx.\n  return (\n    (callee.name === '_jsx' || callee.name === '__jsx') &&\n    componentNode.value === 'link'\n  )\n}\n"],"names":[],"mappings":"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"}