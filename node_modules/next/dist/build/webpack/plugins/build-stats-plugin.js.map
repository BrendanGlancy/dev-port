{"version":3,"sources":["../../../../build/webpack/plugins/build-stats-plugin.ts"],"sourcesContent":["import fs from 'fs'\nimport path from 'path'\nimport { Transform, TransformCallback } from 'stream'\n// @ts-ignore no types package\nimport bfj from 'next/dist/compiled/bfj'\nimport { spans } from './profiling-plugin'\nimport { webpack } from 'next/dist/compiled/webpack/webpack'\n\nconst STATS_VERSION = 0\n\nfunction reduceSize(stats: any) {\n  stats.chunks = stats.chunks.map((chunk: any) => {\n    const reducedChunk: any = {\n      id: chunk.id,\n      files: chunk.files,\n      size: chunk.size,\n    }\n\n    for (const module of chunk.modules) {\n      if (!module.id) {\n        continue\n      }\n\n      if (!reducedChunk.modules) {\n        reducedChunk.modules = []\n      }\n\n      reducedChunk.modules.push(module.id)\n    }\n\n    return reducedChunk\n  })\n\n  stats.modules = stats.modules.map((module: any) => {\n    const reducedModule: any = {\n      type: module.type,\n      moduleType: module.moduleType,\n      size: module.size,\n      name: module.name,\n    }\n\n    if (module.reasons) {\n      for (const reason of module.reasons) {\n        if (!reason.moduleName || reason.moduleId === module.id) {\n          continue\n        }\n\n        if (!reducedModule.reasons) {\n          reducedModule.reasons = []\n        }\n\n        reducedModule.reasons.push(reason.moduleId)\n      }\n    }\n\n    return [module.id, reducedModule]\n  })\n\n  for (const entrypointName in stats.entrypoints) {\n    delete stats.entrypoints[entrypointName].assets\n  }\n\n  return stats\n}\n\nconst THRESHOLD = 16 * 1024\nclass BufferingStream extends Transform {\n  private items: Buffer[] = []\n  private itemsSize = 0\n\n  _transform(\n    chunk: Buffer | string,\n    encoding: BufferEncoding,\n    callback: TransformCallback\n  ): void {\n    const buffer = Buffer.isBuffer(chunk)\n      ? chunk\n      : Buffer.from(chunk as string, encoding)\n    const size = buffer.length\n    if (this.itemsSize > 0 && this.itemsSize + size > THRESHOLD) {\n      this.push(Buffer.concat(this.items))\n      this.itemsSize = 0\n      this.items.length = 0\n    }\n    if (size > THRESHOLD) {\n      this.push(buffer)\n    } else {\n      this.items.push(buffer)\n      this.itemsSize += size\n    }\n\n    callback()\n  }\n\n  _flush(callback: TransformCallback): void {\n    if (this.itemsSize > 0) {\n      this.push(Buffer.concat(this.items))\n      this.itemsSize = 0\n      this.items.length = 0\n    }\n\n    callback()\n  }\n}\n\n// This plugin creates a stats.json for a build when enabled\nexport default class BuildStatsPlugin {\n  private distDir: string\n\n  constructor(options: { distDir: string }) {\n    this.distDir = options.distDir\n  }\n\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.done.tapAsync(\n      'NextJsBuildStats',\n      async (stats, callback) => {\n        const compilerSpan = spans.get(compiler)\n        try {\n          const writeStatsSpan = compilerSpan!.traceChild('NextJsBuildStats')\n          await writeStatsSpan.traceAsyncFn(() => {\n            return new Promise((resolve, reject) => {\n              const statsJson = reduceSize(\n                stats.toJson({\n                  all: false,\n                  cached: true,\n                  reasons: true,\n                  entrypoints: true,\n                  chunks: true,\n                  errors: false,\n                  warnings: false,\n                  maxModules: Infinity,\n                  chunkModules: true,\n                  modules: true,\n                  // @ts-ignore this option exists\n                  ids: true,\n                })\n              )\n              const fileStream = fs.createWriteStream(\n                path.join(this.distDir, 'next-stats.json'),\n                { highWaterMark: THRESHOLD }\n              )\n              const jsonStream = bfj.streamify({\n                version: STATS_VERSION,\n                stats: statsJson,\n              })\n              jsonStream.pipe(new BufferingStream()).pipe(fileStream)\n              jsonStream.on('error', reject)\n              fileStream.on('error', reject)\n              jsonStream.on('dataError', reject)\n              fileStream.on('close', resolve)\n            })\n          })\n          callback()\n        } catch (err) {\n          callback(err)\n        }\n      }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}