{"version":3,"sources":["../../../../build/webpack/plugins/css-minimizer-plugin.ts"],"sourcesContent":["import cssnanoSimple from 'cssnano-simple'\nimport postcssScss from 'next/dist/compiled/postcss-scss'\nimport postcss, { Parser } from 'postcss'\nimport {\n  webpack,\n  isWebpack5,\n  sources,\n} from 'next/dist/compiled/webpack/webpack'\nimport { trace } from '../../../telemetry/trace'\nimport { spans } from './profiling-plugin'\n\n// https://github.com/NMFR/optimize-css-assets-webpack-plugin/blob/0a410a9bf28c7b0e81a3470a13748e68ca2f50aa/src/index.js#L20\nconst CSS_REGEX = /\\.css(\\?.*)?$/i\n\ntype CssMinimizerPluginOptions = {\n  postcssOptions: {\n    map: false | { prev?: string | false; inline: boolean; annotation: boolean }\n  }\n}\n\nexport class CssMinimizerPlugin {\n  __next_css_remove = true\n\n  private options: CssMinimizerPluginOptions\n\n  constructor(options: CssMinimizerPluginOptions) {\n    this.options = options\n  }\n\n  optimizeAsset(file: string, asset: any) {\n    const postcssOptions = {\n      ...this.options.postcssOptions,\n      to: file,\n      from: file,\n\n      // We don't actually add this parser to support Sass. It can also be used\n      // for inline comment support. See the README:\n      // https://github.com/postcss/postcss-scss/blob/master/README.md#2-inline-comments-for-postcss\n      parser: postcssScss as any as Parser,\n    }\n\n    let input: string\n    if (postcssOptions.map && asset.sourceAndMap) {\n      const { source, map } = asset.sourceAndMap()\n      input = source\n      postcssOptions.map.prev = map ? map : false\n    } else {\n      input = asset.source()\n    }\n\n    return postcss([cssnanoSimple({}, postcss)])\n      .process(input, postcssOptions)\n      .then((res) => {\n        if (res.map) {\n          return new sources.SourceMapSource(res.css, file, res.map.toJSON())\n        } else {\n          return new sources.RawSource(res.css)\n        }\n      })\n  }\n\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.compilation.tap('CssMinimizerPlugin', (compilation: any) => {\n      if (isWebpack5) {\n        const cache = compilation.getCache('CssMinimizerPlugin')\n        compilation.hooks.processAssets.tapPromise(\n          {\n            name: 'CssMinimizerPlugin',\n            // @ts-ignore TODO: Remove ignore when webpack 5 is stable\n            stage: webpack.Compilation.PROCESS_ASSETS_STAGE_OPTIMIZE_SIZE,\n          },\n          async (assets: any) => {\n            const compilerSpan = spans.get(compiler)\n            const cssMinimizerSpan = compilerSpan!.traceChild(\n              'css-minimizer-plugin'\n            )\n            cssMinimizerSpan.setAttribute('webpackVersion', 5)\n\n            return cssMinimizerSpan.traceAsyncFn(async () => {\n              const files = Object.keys(assets)\n              await Promise.all(\n                files\n                  .filter((file) => CSS_REGEX.test(file))\n                  .map(async (file) => {\n                    const assetSpan = cssMinimizerSpan.traceChild('minify-css')\n                    assetSpan.setAttribute('file', file)\n\n                    return assetSpan.traceAsyncFn(async () => {\n                      const asset = assets[file]\n\n                      const etag = cache.getLazyHashedEtag(asset)\n\n                      const cachedResult = await cache.getPromise(file, etag)\n\n                      assetSpan.setAttribute(\n                        'cache',\n                        cachedResult ? 'HIT' : 'MISS'\n                      )\n                      if (cachedResult) {\n                        assets[file] = cachedResult\n                        return\n                      }\n\n                      const result = await this.optimizeAsset(file, asset)\n                      await cache.storePromise(file, etag, result)\n                      assets[file] = result\n                    })\n                  })\n              )\n            })\n          }\n        )\n        return\n      }\n      compilation.hooks.optimizeChunkAssets.tapPromise(\n        'CssMinimizerPlugin',\n        (chunks: webpack.compilation.Chunk[]) => {\n          const compilerSpan = spans.get(compiler)\n          const cssMinimizerSpan = trace(\n            'css-minimizer-plugin',\n            compilerSpan?.id\n          )\n          cssMinimizerSpan.setAttribute('webpackVersion', 4)\n          cssMinimizerSpan.setAttribute('compilationName', compilation.name)\n\n          return cssMinimizerSpan.traceAsyncFn(async () => {\n            return await Promise.all(\n              chunks\n                .reduce(\n                  (acc, chunk) => acc.concat(chunk.files || []),\n                  [] as string[]\n                )\n                .filter((entry) => CSS_REGEX.test(entry))\n                .map(async (file) => {\n                  const assetSpan = trace('minify-css', cssMinimizerSpan.id)\n                  assetSpan.setAttribute('file', file)\n\n                  return assetSpan.traceAsyncFn(async () => {\n                    const asset = compilation.assets[file]\n                    // Makes trace attributes the same as webpack 5\n                    // When using webpack 4 the result is not cached\n                    assetSpan.setAttribute('cache', 'MISS')\n                    compilation.assets[file] = await this.optimizeAsset(\n                      file,\n                      asset\n                    )\n                  })\n                })\n            )\n          })\n        }\n      )\n    })\n  }\n}\n"],"names":[],"mappings":"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"}