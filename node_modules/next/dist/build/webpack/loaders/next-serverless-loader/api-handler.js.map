{"version":3,"sources":["../../../../../build/webpack/loaders/next-serverless-loader/api-handler.ts"],"sourcesContent":["import { parse as parseUrl } from 'url'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport { apiResolver } from '../../../../server/api-utils'\nimport { getUtils, vercelHeader, ServerlessHandlerCtx } from './utils'\nimport { DecodeError } from '../../../../shared/lib/utils'\n\nexport function getApiHandler(ctx: ServerlessHandlerCtx) {\n  const { pageModule, encodedPreviewProps, pageIsDynamic } = ctx\n  const {\n    handleRewrites,\n    handleBasePath,\n    dynamicRouteMatcher,\n    normalizeDynamicRouteParams,\n  } = getUtils(ctx)\n\n  return async (req: IncomingMessage, res: ServerResponse) => {\n    try {\n      // We need to trust the dynamic route params from the proxy\n      // to ensure we are using the correct values\n      const trustQuery = req.headers[vercelHeader]\n      const parsedUrl = handleRewrites(req, parseUrl(req.url!, true))\n\n      if (parsedUrl.query.nextInternalLocale) {\n        delete parsedUrl.query.nextInternalLocale\n      }\n      handleBasePath(req, parsedUrl)\n\n      let params = {}\n\n      if (pageIsDynamic) {\n        const result = normalizeDynamicRouteParams(\n          trustQuery\n            ? parsedUrl.query\n            : (dynamicRouteMatcher!(parsedUrl.pathname) as Record<\n                string,\n                string | string[]\n              >)\n        )\n\n        params = result.params\n      }\n\n      await apiResolver(\n        req,\n        res,\n        Object.assign({}, parsedUrl.query, params),\n        await pageModule,\n        encodedPreviewProps,\n        true\n      )\n    } catch (err) {\n      console.error(err)\n\n      if (err instanceof DecodeError) {\n        res.statusCode = 400\n        res.end('Bad Request')\n      } else {\n        // Throw the error to crash the serverless function\n        throw err\n      }\n    }\n  }\n}\n"],"names":[],"mappings":";;;;QAMgB,aAAa,GAAb,aAAa;AANK,GAAK,CAAL,IAAK;AAEX,GAA8B,CAA9B,SAA8B;AACG,GAAS,CAAT,MAAS;AAC1C,GAA8B,CAA9B,OAA8B;SAE1C,aAAa,CAAC,GAAyB,EAAE,CAAC;IACxD,KAAK,GAAG,UAAU,GAAE,mBAAmB,GAAE,aAAa,MAAK,GAAG;IAC9D,KAAK,GACH,cAAc,GACd,cAAc,GACd,mBAAmB,GACnB,2BAA2B,YAT8B,MAAS,WAUvD,GAAG;kBAEF,GAAoB,EAAE,GAAmB,GAAK,CAAC;YACvD,CAAC;YACH,EAA2D,AAA3D,yDAA2D;YAC3D,EAA4C,AAA5C,0CAA4C;YAC5C,KAAK,CAAC,UAAU,GAAG,GAAG,CAAC,OAAO,CAhByB,MAAS;YAiBhE,KAAK,CAAC,SAAS,GAAG,cAAc,CAAC,GAAG,MApBR,IAAK,QAoBc,GAAG,CAAC,GAAG,EAAG,IAAI;YAE7D,EAAE,EAAE,SAAS,CAAC,KAAK,CAAC,kBAAkB,EAAE,CAAC;uBAChC,SAAS,CAAC,KAAK,CAAC,kBAAkB;YAC3C,CAAC;YACD,cAAc,CAAC,GAAG,EAAE,SAAS;YAE7B,GAAG,CAAC,MAAM;;YAEV,EAAE,EAAE,aAAa,EAAE,CAAC;gBAClB,KAAK,CAAC,MAAM,GAAG,2BAA2B,CACxC,UAAU,GACN,SAAS,CAAC,KAAK,GACd,mBAAmB,CAAE,SAAS,CAAC,QAAQ;gBAM9C,MAAM,GAAG,MAAM,CAAC,MAAM;YACxB,CAAC;sBAtCqB,SAA8B,cAyClD,GAAG,EACH,GAAG,EACH,MAAM,CAAC,MAAM;eAAK,SAAS,CAAC,KAAK,EAAE,MAAM,SACnC,UAAU,EAChB,mBAAmB,EACnB,IAAI;QAER,CAAC,QAAQ,GAAG,EAAE,CAAC;YACb,OAAO,CAAC,KAAK,CAAC,GAAG;YAEjB,EAAE,EAAE,GAAG,YAjDe,OAA8B,cAiDpB,CAAC;gBAC/B,GAAG,CAAC,UAAU,GAAG,GAAG;gBACpB,GAAG,CAAC,GAAG,EAAC,WAAa;YACvB,CAAC,MAAM,CAAC;gBACN,EAAmD,AAAnD,iDAAmD;gBACnD,KAAK,CAAC,GAAG;YACX,CAAC;QACH,CAAC;IACH,CAAC;AACH,CAAC"}