{"version":3,"sources":["../../../../../../build/webpack/loaders/babel-loader/src/cache.js"],"sourcesContent":["import { createHash } from 'crypto'\nimport { trace } from '../../../../../telemetry/trace'\nimport transform from './transform'\nimport cacache from 'next/dist/compiled/cacache'\n\nasync function read(cacheDirectory, etag) {\n  const cachedResult = await trace('read-cache-file').traceAsyncFn(() =>\n    cacache.get(cacheDirectory, etag)\n  )\n  return JSON.parse(cachedResult.data)\n}\n\nfunction write(cacheDirectory, etag, data) {\n  return trace('write-cache-file').traceAsyncFn(() =>\n    cacache.put(cacheDirectory, etag, JSON.stringify(data))\n  )\n}\n\nconst etag = function (source, identifier, options) {\n  return trace('etag').traceFn(() => {\n    const hash = createHash('md4')\n\n    const contents = JSON.stringify({ source, options, identifier })\n\n    hash.update(contents)\n\n    return hash.digest('hex')\n  })\n}\n\nexport default async function handleCache(params) {\n  const span = trace('handle-cache')\n\n  return span.traceAsyncFn(async () => {\n    const { source, options = {}, cacheIdentifier, cacheDirectory } = params\n\n    const file = etag(source, cacheIdentifier)\n\n    try {\n      // No errors mean that the file was previously cached\n      // we just need to return it\n      const res = await read(cacheDirectory, file)\n      span.setAttribute('cache', res ? 'HIT' : 'MISS')\n      return res\n    } catch (err) {}\n\n    // Otherwise just transform the file\n    // return it to the user asap and write it in cache\n    const result = await trace('transform').traceAsyncFn(async () => {\n      return transform(source, options)\n    })\n\n    await write(cacheDirectory, file, result)\n\n    return result\n  })\n}\n"],"names":[],"mappings":";;;;kBA8B8B,WAAW;AA9Bd,GAAQ,CAAR,OAAQ;AACb,GAAgC,CAAhC,MAAgC;AAChC,GAAa,CAAb,UAAa;AACf,GAA4B,CAA5B,QAA4B;;;;;;eAEjC,IAAI,CAAC,cAAc,EAAE,IAAI,EAAE,CAAC;IACzC,KAAK,CAAC,YAAY,aALE,MAAgC,SAKnB,eAAiB,GAAE,YAAY,KAH9C,QAA4B,SAIpC,GAAG,CAAC,cAAc,EAAE,IAAI;;WAE3B,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,IAAI;AACrC,CAAC;SAEQ,KAAK,CAAC,cAAc,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC;eAXtB,MAAgC,SAYvC,gBAAkB,GAAE,YAAY,KAV3B,QAA4B,SAWpC,GAAG,CAAC,cAAc,EAAE,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,IAAI;;AAEzD,CAAC;AAED,KAAK,CAAC,IAAI,YAAa,MAAM,EAAE,UAAU,EAAE,OAAO,EAAE,CAAC;eAjB/B,MAAgC,SAkBvC,IAAM,GAAE,OAAO,KAAO,CAAC;QAClC,KAAK,CAAC,IAAI,OApBa,OAAQ,cAoBP,GAAK;QAE7B,KAAK,CAAC,QAAQ,GAAG,IAAI,CAAC,SAAS;YAAG,MAAM;YAAE,OAAO;YAAE,UAAU;;QAE7D,IAAI,CAAC,MAAM,CAAC,QAAQ;eAEb,IAAI,CAAC,MAAM,EAAC,GAAK;IAC1B,CAAC;AACH,CAAC;eAE6B,WAAW,CAAC,MAAM,EAAE,CAAC;IACjD,KAAK,CAAC,IAAI,OA9BU,MAAgC,SA8BjC,YAAc;WAE1B,IAAI,CAAC,YAAY,WAAa,CAAC;QACpC,KAAK,GAAG,MAAM,GAAE,OAAO;YAAO,eAAe,GAAE,cAAc,MAAK,MAAM;QAExE,KAAK,CAAC,IAAI,GAAG,IAAI,CAAC,MAAM,EAAE,eAAe;YAErC,CAAC;YACH,EAAqD,AAArD,mDAAqD;YACrD,EAA4B,AAA5B,0BAA4B;YAC5B,KAAK,CAAC,GAAG,SAAS,IAAI,CAAC,cAAc,EAAE,IAAI;YAC3C,IAAI,CAAC,YAAY,EAAC,KAAO,GAAE,GAAG,IAAG,GAAK,KAAG,IAAM;mBACxC,GAAG;QACZ,CAAC,QAAQ,GAAG,EAAE,CAAC;QAAA,CAAC;QAEhB,EAAoC,AAApC,kCAAoC;QACpC,EAAmD,AAAnD,iDAAmD;QACnD,KAAK,CAAC,MAAM,aA/CM,MAAgC,SA+CvB,SAAW,GAAE,YAAY,WAAa,CAAC;uBA9ChD,UAAa,UA+CZ,MAAM,EAAE,OAAO;QAClC,CAAC;cAEK,KAAK,CAAC,cAAc,EAAE,IAAI,EAAE,MAAM;eAEjC,MAAM;IACf,CAAC;AACH,CAAC"}