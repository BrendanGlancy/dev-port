{"version":3,"sources":["../../../../../../build/webpack/loaders/babel-loader/src/index.js"],"sourcesContent":["// import babel from 'next/dist/compiled/babel/core'\nimport loaderUtils from 'next/dist/compiled/loader-utils'\nimport { trace } from '../../../../../telemetry/trace'\nimport cache from './cache'\nimport transform from './transform'\n\n// When using `import` Babel will be undefined\nconst babel = require('next/dist/compiled/babel/core')\n\nexport default function makeLoader(callback) {\n  const overrides = callback(babel)\n\n  return function (source, inputSourceMap) {\n    // Make the loader async\n    const cb = this.async()\n\n    loader.call(this, source, inputSourceMap, overrides).then(\n      (args) => cb(null, ...args),\n      (err) => cb(err)\n    )\n  }\n}\n\nasync function loader(source, inputSourceMap, overrides) {\n  // this.currentTraceSpan is provided by profiling-plugin.ts\n  const loaderSpan = trace('babel-loader', this.currentTraceSpan?.id)\n\n  return loaderSpan.traceAsyncFn(async () => {\n    const filename = this.resourcePath\n    loaderSpan.setAttribute('filename', filename)\n\n    let loaderOptions = loaderUtils.getOptions(this) || {}\n\n    let customOptions\n    if (overrides && overrides.customOptions) {\n      const customoptionsSpan = trace('loader-overrides-customoptions')\n      const result = await customoptionsSpan.traceAsyncFn(\n        async () =>\n          await overrides.customOptions.call(this, loaderOptions, {\n            source,\n            map: inputSourceMap,\n          })\n      )\n      customOptions = result.custom\n      loaderOptions = result.loader\n    }\n\n    // Standardize on 'sourceMaps' as the key passed through to Webpack, so that\n    // users may safely use either one alongside our default use of\n    // 'this.sourceMap' below without getting error about conflicting aliases.\n    if (\n      Object.prototype.hasOwnProperty.call(loaderOptions, 'sourceMap') &&\n      !Object.prototype.hasOwnProperty.call(loaderOptions, 'sourceMaps')\n    ) {\n      loaderOptions = Object.assign({}, loaderOptions, {\n        sourceMaps: loaderOptions.sourceMap,\n      })\n      delete loaderOptions.sourceMap\n    }\n\n    const programmaticOptions = Object.assign({}, loaderOptions, {\n      filename,\n      inputSourceMap: inputSourceMap || undefined,\n\n      // Set the default sourcemap behavior based on Webpack's mapping flag,\n      // but allow users to override if they want.\n      sourceMaps:\n        loaderOptions.sourceMaps === undefined\n          ? this.sourceMap\n          : loaderOptions.sourceMaps,\n\n      // Ensure that Webpack will get a full absolute path in the sourcemap\n      // so that it can properly map the module back to its internal cached\n      // modules.\n      sourceFileName: filename,\n      caller: {\n        name: 'babel-loader',\n\n        // Provide plugins with insight into webpack target.\n        // https://github.com/babel/babel-loader/issues/787\n        target: this.target,\n\n        // Webpack >= 2 supports ESM and dynamic import.\n        supportsStaticESM: true,\n        supportsDynamicImport: true,\n\n        // Webpack 5 supports TLA behind a flag. We enable it by default\n        // for Babel, and then webpack will throw an error if the experimental\n        // flag isn't enabled.\n        supportsTopLevelAwait: true,\n        ...loaderOptions.caller,\n      },\n    })\n    // Remove loader related options\n    delete programmaticOptions.cacheDirectory\n    delete programmaticOptions.cacheIdentifier\n\n    const partialConfigSpan = trace('babel-load-partial-config-async')\n    const config = partialConfigSpan.traceFn(() => {\n      return babel.loadPartialConfig(programmaticOptions)\n    })\n\n    if (config) {\n      let options = config.options\n      if (overrides && overrides.config) {\n        const overridesSpan = trace('loader-overrides-config')\n        options = await overridesSpan.traceAsyncFn(\n          async () =>\n            await overrides.config.call(this, config, {\n              source,\n              map: inputSourceMap,\n              customOptions,\n            })\n        )\n      }\n\n      if (options.sourceMaps === 'inline') {\n        // Babel has this weird behavior where if you set \"inline\", we\n        // inline the sourcemap, and set 'result.map = null'. This results\n        // in bad behavior from Babel since the maps get put into the code,\n        // which Webpack does not expect, and because the map we return to\n        // Webpack is null, which is also bad. To avoid that, we override the\n        // behavior here so \"inline\" just behaves like 'true'.\n        options.sourceMaps = true\n      }\n\n      const { cacheDirectory, cacheIdentifier } = loaderOptions\n\n      let result\n      if (cacheDirectory) {\n        result = await cache({\n          source,\n          options,\n          cacheDirectory,\n          cacheIdentifier,\n          cacheCompression: false,\n        })\n      } else {\n        const transformSpan = trace('transform')\n        transformSpan.setAttribute('filename', filename)\n        transformSpan.setAttribute('cache', 'DISABLED')\n        result = await transformSpan.traceAsyncFn(async () => {\n          return transform(source, options)\n        })\n      }\n\n      // TODO: Babel should really provide the full list of config files that\n      // were used so that this can also handle files loaded with 'extends'.\n      if (typeof config.babelrc === 'string') {\n        this.addDependency(config.babelrc)\n      }\n\n      if (result) {\n        const { code, map } = result\n\n        return [code, map]\n      }\n    }\n\n    // If the file was ignored, pass through the original content.\n    return [source, inputSourceMap]\n  })\n}\n"],"names":[],"mappings":"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"}