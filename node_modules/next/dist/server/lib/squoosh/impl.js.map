{"version":3,"sources":["../../../../server/lib/squoosh/impl.ts"],"sourcesContent":["import semver from 'next/dist/compiled/semver'\nimport { codecs as supportedFormats, preprocessors } from './codecs'\nimport ImageData from './image_data'\n\n// Fixed in Node.js 16.5.0 and newer.\n// See https://github.com/nodejs/node/pull/39337\n// Eventually, remove this delay when engines is updated.\n// See https://git.io/JCTr0\nconst FIXED_VERSION = '16.5.0'\nconst DELAY_MS = 1000\nlet _promise: Promise<void> | undefined\n\nfunction delayOnce(ms: number): Promise<void> {\n  if (!_promise) {\n    _promise = new Promise((resolve) => {\n      setTimeout(resolve, ms)\n    })\n  }\n  return _promise\n}\n\nfunction maybeDelay(): Promise<void> {\n  const isAppleM1 = process.arch === 'arm64' && process.platform === 'darwin'\n  if (isAppleM1 && semver.lt(process.version, FIXED_VERSION)) {\n    return delayOnce(DELAY_MS)\n  }\n  return Promise.resolve()\n}\n\nexport async function decodeBuffer(\n  _buffer: Buffer | Uint8Array\n): Promise<ImageData> {\n  const buffer = Buffer.from(_buffer)\n  const firstChunk = buffer.slice(0, 16)\n  const firstChunkString = Array.from(firstChunk)\n    .map((v) => String.fromCodePoint(v))\n    .join('')\n  const key = Object.entries(supportedFormats).find(([, { detectors }]) =>\n    detectors.some((detector) => detector.exec(firstChunkString))\n  )?.[0] as keyof typeof supportedFormats\n  if (!key) {\n    throw Error(`Buffer has an unsupported format`)\n  }\n  const d = await supportedFormats[key].dec()\n  return d.decode(new Uint8Array(buffer))\n}\n\nexport async function rotate(\n  image: ImageData,\n  numRotations: number\n): Promise<ImageData> {\n  image = ImageData.from(image)\n\n  const m = await preprocessors['rotate'].instantiate()\n  return await m(image.data, image.width, image.height, { numRotations })\n}\n\ntype ResizeOpts = { image: ImageData } & (\n  | { width: number; height?: never }\n  | { height: number; width?: never }\n)\n\nexport async function resize({ image, width, height }: ResizeOpts) {\n  image = ImageData.from(image)\n\n  const p = preprocessors['resize']\n  const m = await p.instantiate()\n  await maybeDelay()\n  return await m(image.data, image.width, image.height, {\n    ...p.defaultOptions,\n    width,\n    height,\n  })\n}\n\nexport async function encodeJpeg(\n  image: ImageData,\n  { quality }: { quality: number }\n): Promise<Buffer | Uint8Array> {\n  image = ImageData.from(image)\n\n  const e = supportedFormats['mozjpeg']\n  const m = await e.enc()\n  await maybeDelay()\n  const r = await m.encode!(image.data, image.width, image.height, {\n    ...e.defaultEncoderOptions,\n    quality,\n  })\n  return Buffer.from(r)\n}\n\nexport async function encodeWebp(\n  image: ImageData,\n  { quality }: { quality: number }\n): Promise<Buffer | Uint8Array> {\n  image = ImageData.from(image)\n\n  const e = supportedFormats['webp']\n  const m = await e.enc()\n  await maybeDelay()\n  const r = await m.encode!(image.data, image.width, image.height, {\n    ...e.defaultEncoderOptions,\n    quality,\n  })\n  return Buffer.from(r)\n}\n\nexport async function encodePng(\n  image: ImageData\n): Promise<Buffer | Uint8Array> {\n  image = ImageData.from(image)\n\n  const e = supportedFormats['oxipng']\n  const m = await e.enc()\n  await maybeDelay()\n  const r = await m.encode(image.data, image.width, image.height, {\n    ...e.defaultEncoderOptions,\n  })\n  return Buffer.from(r)\n}\n"],"names":[],"mappings":"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"}