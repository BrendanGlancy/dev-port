{"version":3,"sources":["../../server/config-utils-worker.ts"],"sourcesContent":["import { loadEnvConfig } from '@next/env'\nimport findUp from 'next/dist/compiled/find-up'\nimport { init as initWebpack } from 'next/dist/compiled/webpack/webpack'\nimport { CONFIG_FILE, PHASE_DEVELOPMENT_SERVER } from '../shared/lib/constants'\nimport { NextConfig, normalizeConfig } from './config-shared'\nimport * as Log from '../build/output/log'\n\nlet installed: boolean = false\n\nexport function install(useWebpack5: boolean) {\n  if (installed) {\n    return\n  }\n  installed = true\n\n  initWebpack(useWebpack5)\n\n  // hook the Node.js require so that webpack requires are\n  // routed to the bundled and now initialized webpack version\n  require('../build/webpack/require-hook')\n}\n\nexport type CheckReasons =\n  | 'test-mode'\n  | 'default'\n  | 'flag-disabled'\n  | 'future-flag'\n\nexport type CheckResult = {\n  enabled: boolean\n  reason: CheckReasons\n}\n\nexport async function shouldLoadWithWebpack5(\n  phase: string,\n  dir: string\n): Promise<CheckResult> {\n  await loadEnvConfig(dir, phase === PHASE_DEVELOPMENT_SERVER, Log)\n\n  const path = await findUp(CONFIG_FILE, {\n    cwd: dir,\n  })\n\n  if (Number(process.env.NEXT_PRIVATE_TEST_WEBPACK4_MODE) > 0) {\n    return {\n      enabled: false,\n      reason: 'test-mode',\n    }\n  }\n\n  // Use webpack 5 by default in apps that do not have next.config.js\n  if (!path?.length) {\n    return {\n      enabled: true,\n      reason: 'default',\n    }\n  }\n\n  // Default to webpack 4 for backwards compatibility on boot:\n  install(false)\n\n  const userConfigModule = require(path)\n  const userConfig: Partial<NextConfig> = normalizeConfig(\n    phase,\n    userConfigModule.default || userConfigModule\n  )\n\n  if (userConfig.future?.webpack5) {\n    return {\n      enabled: false,\n      reason: 'future-flag',\n    }\n  }\n  if (userConfig.webpack5 === false) {\n    return {\n      enabled: false,\n      reason: 'flag-disabled',\n    }\n  }\n\n  return {\n    enabled: true,\n    reason: 'default',\n  }\n}\n"],"names":[],"mappings":";;;;QASgB,OAAO,GAAP,OAAO;QAwBD,sBAAsB,GAAtB,sBAAsB;AAjCd,GAAW,CAAX,IAAW;AACtB,GAA4B,CAA5B,OAA4B;AACX,GAAoC,CAApC,QAAoC;AAClB,GAAyB,CAAzB,UAAyB;AACnC,GAAiB,CAAjB,aAAiB;AACjD,GAAG,CAAH,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEf,GAAG,CAAC,SAAS,GAAY,KAAK;SAEd,OAAO,CAAC,WAAoB,EAAE,CAAC;IAC7C,EAAE,EAAE,SAAS,EAAE,CAAC;;IAEhB,CAAC;IACD,SAAS,GAAG,IAAI;QAXkB,QAAoC,OAa1D,WAAW;IAEvB,EAAwD,AAAxD,sDAAwD;IACxD,EAA4D,AAA5D,0DAA4D;IAC5D,OAAO,EAAC,6BAA+B;AACzC,CAAC;eAaqB,sBAAsB,CAC1C,KAAa,EACb,GAAW,EACW,CAAC;QA+BnB,GAAiB;cAnEO,IAAW,gBAqCnB,GAAG,EAAE,KAAK,KAlCsB,UAAyB,2BAEnE,GAAG;IAkCb,KAAK,CAAC,IAAI,aAtCO,OAA4B,UAEO,UAAyB;QAqC3E,GAAG,EAAE,GAAG;;IAGV,EAAE,EAAE,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,+BAA+B,IAAI,CAAC,EAAE,CAAC;;YAE1D,OAAO,EAAE,KAAK;YACd,MAAM,GAAE,SAAW;;IAEvB,CAAC;IAED,EAAmE,AAAnE,iEAAmE;IACnE,EAAE,IAAG,IAAI,aAAJ,IAAI,UAAJ,CAAY,QAAZ,CAAY,GAAZ,IAAI,CAAE,MAAM,GAAE,CAAC;;YAEhB,OAAO,EAAE,IAAI;YACb,MAAM,GAAE,OAAS;;IAErB,CAAC;IAED,EAA4D,AAA5D,0DAA4D;IAC5D,OAAO,CAAC,KAAK;IAEb,KAAK,CAAC,gBAAgB,GAAG,OAAO,CAAC,IAAI;IACrC,KAAK,CAAC,UAAU,OA1D0B,aAAiB,kBA2DzD,KAAK,EACL,gBAAgB,CAAC,OAAO,IAAI,gBAAgB;IAG9C,EAAE,GAAE,GAAiB,GAAjB,UAAU,CAAC,MAAM,cAAjB,GAAiB,UAAjB,CAA2B,QAA3B,CAA2B,GAA3B,GAAiB,CAAE,QAAQ,EAAE,CAAC;;YAE9B,OAAO,EAAE,KAAK;YACd,MAAM,GAAE,WAAa;;IAEzB,CAAC;IACD,EAAE,EAAE,UAAU,CAAC,QAAQ,KAAK,KAAK,EAAE,CAAC;;YAEhC,OAAO,EAAE,KAAK;YACd,MAAM,GAAE,aAAe;;IAE3B,CAAC;;QAGC,OAAO,EAAE,IAAI;QACb,MAAM,GAAE,OAAS;;AAErB,CAAC"}