{"version":3,"sources":["../../server/font-utils.ts"],"sourcesContent":["import * as Log from '../build/output/log'\nimport { GOOGLE_FONT_PROVIDER } from '../shared/lib/constants'\nconst https = require('https')\n\nconst CHROME_UA =\n  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36'\nconst IE_UA = 'Mozilla/5.0 (Windows NT 10.0; Trident/7.0; rv:11.0) like Gecko'\n\nexport type FontManifest = Array<{\n  url: string\n  content: string\n}>\n\nfunction isGoogleFont(url: string): boolean {\n  return url.startsWith(GOOGLE_FONT_PROVIDER)\n}\n\nfunction getFontForUA(url: string, UA: string): Promise<String> {\n  return new Promise((resolve, reject) => {\n    let rawData: any = ''\n    https\n      .get(\n        url,\n        {\n          headers: {\n            'user-agent': UA,\n          },\n        },\n        (res: any) => {\n          res.on('data', (chunk: any) => {\n            rawData += chunk\n          })\n          res.on('end', () => {\n            resolve(rawData.toString('utf8'))\n          })\n        }\n      )\n      .on('error', (e: Error) => {\n        reject(e)\n      })\n  })\n}\n\nexport async function getFontDefinitionFromNetwork(\n  url: string\n): Promise<string> {\n  let result = ''\n  /**\n   * The order of IE -> Chrome is important, other wise chrome starts loading woff1.\n   * CSS cascading 🤷‍♂️.\n   */\n  try {\n    if (isGoogleFont(url)) {\n      result += await getFontForUA(url, IE_UA)\n    }\n    result += await getFontForUA(url, CHROME_UA)\n  } catch (e) {\n    Log.warn(\n      `Failed to download the stylesheet for ${url}. Skipped optimizing this font.`\n    )\n    return ''\n  }\n\n  return result\n}\n\nexport function getFontDefinitionFromManifest(\n  url: string,\n  manifest: FontManifest\n): string {\n  return (\n    manifest.find((font) => {\n      if (font && font.url === url) {\n        return true\n      }\n      return false\n    })?.content || ''\n  )\n}\n"],"names":[],"mappings":";;;;QA2CsB,4BAA4B,GAA5B,4BAA4B;QAuBlC,6BAA6B,GAA7B,6BAA6B;AAlEjC,GAAG,CAAH,GAAG;AACsB,GAAyB,CAAzB,UAAyB;;;;;;;;;;;;;;;;;;;;;;;;AAC9D,KAAK,CAAC,KAAK,GAAG,OAAO,EAAC,KAAO;AAE7B,KAAK,CAAC,SAAS,IACb,wHAA0H;AAC5H,KAAK,CAAC,KAAK,IAAG,8DAAgE;SAOrE,YAAY,CAAC,GAAW,EAAW,CAAC;WACpC,GAAG,CAAC,UAAU,CAbc,UAAyB;AAc9D,CAAC;SAEQ,YAAY,CAAC,GAAW,EAAE,EAAU,EAAmB,CAAC;WACxD,GAAG,CAAC,OAAO,EAAE,OAAO,EAAE,MAAM,GAAK,CAAC;QACvC,GAAG,CAAC,OAAO;QACX,KAAK,CACF,GAAG,CACF,GAAG;YAED,OAAO;iBACL,UAAY,GAAE,EAAE;;YAGnB,GAAQ,GAAK,CAAC;YACb,GAAG,CAAC,EAAE,EAAC,IAAM,IAAG,KAAU,GAAK,CAAC;gBAC9B,OAAO,IAAI,KAAK;YAClB,CAAC;YACD,GAAG,CAAC,EAAE,EAAC,GAAK,OAAQ,CAAC;gBACnB,OAAO,CAAC,OAAO,CAAC,QAAQ,EAAC,IAAM;YACjC,CAAC;QACH,CAAC,EAEF,EAAE,EAAC,KAAO,IAAG,CAAQ,GAAK,CAAC;YAC1B,MAAM,CAAC,CAAC;QACV,CAAC;IACL,CAAC;AACH,CAAC;eAEqB,4BAA4B,CAChD,GAAW,EACM,CAAC;IAClB,GAAG,CAAC,MAAM;IACV,EAGG,AAHH;;;GAGG,AAHH,EAGG,KACC,CAAC;QACH,EAAE,EAAE,YAAY,CAAC,GAAG,GAAG,CAAC;YACtB,MAAM,UAAU,YAAY,CAAC,GAAG,EAAE,KAAK;QACzC,CAAC;QACD,MAAM,UAAU,YAAY,CAAC,GAAG,EAAE,SAAS;IAC7C,CAAC,QAAQ,CAAC,EAAE,CAAC;QAxDH,GAAG,CAyDP,IAAI,EACL,sCAAsC,EAAE,GAAG,CAAC,+BAA+B;;IAGhF,CAAC;WAEM,MAAM;AACf,CAAC;SAEe,6BAA6B,CAC3C,GAAW,EACX,QAAsB,EACd,CAAC;QAEP,GAKE;aALF,GAKE,GALF,QAAQ,CAAC,IAAI,EAAE,IAAI,GAAK,CAAC;QACvB,EAAE,EAAE,IAAI,IAAI,IAAI,CAAC,GAAG,KAAK,GAAG,EAAE,CAAC;mBACtB,IAAI;QACb,CAAC;eACM,KAAK;IACd,CAAC,eALD,GAKE,UALF,CAKW,QALX,CAKW,GALX,GAKE,CAAE,OAAO;AAEf,CAAC"}