{"version":3,"sources":["../../server/api-utils.ts"],"sourcesContent":["import { IncomingMessage, ServerResponse } from 'http'\nimport { parse } from 'next/dist/compiled/content-type'\nimport { CookieSerializeOptions } from 'next/dist/compiled/cookie'\nimport getRawBody from 'raw-body'\nimport { PageConfig, PreviewData } from 'next/types'\nimport { Stream } from 'stream'\nimport { isResSent, NextApiRequest, NextApiResponse } from '../shared/lib/utils'\nimport { decryptWithSecret, encryptWithSecret } from './crypto-utils'\nimport { interopDefault } from './load-components'\nimport { sendEtagResponse } from './send-payload'\nimport generateETag from 'etag'\n\nexport type NextApiRequestCookies = { [key: string]: string }\nexport type NextApiRequestQuery = { [key: string]: string | string[] }\n\nexport type __ApiPreviewProps = {\n  previewModeId: string\n  previewModeEncryptionKey: string\n  previewModeSigningKey: string\n}\n\nexport async function apiResolver(\n  req: IncomingMessage,\n  res: ServerResponse,\n  query: any,\n  resolverModule: any,\n  apiContext: __ApiPreviewProps,\n  propagateError: boolean,\n  dev?: boolean,\n  page?: string\n): Promise<void> {\n  const apiReq = req as NextApiRequest\n  const apiRes = res as NextApiResponse\n\n  try {\n    if (!resolverModule) {\n      res.statusCode = 404\n      res.end('Not Found')\n      return\n    }\n    const config: PageConfig = resolverModule.config || {}\n    const bodyParser = config.api?.bodyParser !== false\n    const externalResolver = config.api?.externalResolver || false\n\n    // Parsing of cookies\n    setLazyProp({ req: apiReq }, 'cookies', getCookieParser(req.headers))\n    // Parsing query string\n    apiReq.query = query\n    // Parsing preview data\n    setLazyProp({ req: apiReq }, 'previewData', () =>\n      tryGetPreviewData(req, res, apiContext)\n    )\n    // Checking if preview mode is enabled\n    setLazyProp({ req: apiReq }, 'preview', () =>\n      apiReq.previewData !== false ? true : undefined\n    )\n\n    // Parsing of body\n    if (bodyParser && !apiReq.body) {\n      apiReq.body = await parseBody(\n        apiReq,\n        config.api && config.api.bodyParser && config.api.bodyParser.sizeLimit\n          ? config.api.bodyParser.sizeLimit\n          : '1mb'\n      )\n    }\n\n    let contentLength = 0\n    const writeData = apiRes.write\n    const endResponse = apiRes.end\n    apiRes.write = (...args: any[2]) => {\n      contentLength += Buffer.byteLength(args[0])\n      return writeData.apply(apiRes, args)\n    }\n    apiRes.end = (...args: any[2]) => {\n      if (args.length && typeof args[0] !== 'function') {\n        contentLength += Buffer.byteLength(args[0])\n      }\n\n      if (contentLength >= 4 * 1024 * 1024) {\n        console.warn(\n          `API response for ${req.url} exceeds 4MB. This will cause the request to fail in a future version. https://nextjs.org/docs/messages/api-routes-body-size-limit`\n        )\n      }\n\n      endResponse.apply(apiRes, args)\n    }\n    apiRes.status = (statusCode) => sendStatusCode(apiRes, statusCode)\n    apiRes.send = (data) => sendData(apiReq, apiRes, data)\n    apiRes.json = (data) => sendJson(apiRes, data)\n    apiRes.redirect = (statusOrUrl: number | string, url?: string) =>\n      redirect(apiRes, statusOrUrl, url)\n    apiRes.setPreviewData = (data, options = {}) =>\n      setPreviewData(apiRes, data, Object.assign({}, apiContext, options))\n    apiRes.clearPreviewData = () => clearPreviewData(apiRes)\n\n    const resolver = interopDefault(resolverModule)\n    let wasPiped = false\n\n    if (process.env.NODE_ENV !== 'production') {\n      // listen for pipe event and don't show resolve warning\n      res.once('pipe', () => (wasPiped = true))\n    }\n\n    // Call API route method\n    await resolver(req, res)\n\n    if (\n      process.env.NODE_ENV !== 'production' &&\n      !externalResolver &&\n      !isResSent(res) &&\n      !wasPiped\n    ) {\n      console.warn(\n        `API resolved without sending a response for ${req.url}, this may result in stalled requests.`\n      )\n    }\n  } catch (err) {\n    if (err instanceof ApiError) {\n      sendError(apiRes, err.statusCode, err.message)\n    } else {\n      if (dev) {\n        if (err) {\n          err.page = page\n        }\n        throw err\n      }\n\n      console.error(err)\n      if (propagateError) {\n        throw err\n      }\n      sendError(apiRes, 500, 'Internal Server Error')\n    }\n  }\n}\n\n/**\n * Parse incoming message like `json` or `urlencoded`\n * @param req request object\n */\nexport async function parseBody(\n  req: NextApiRequest,\n  limit: string | number\n): Promise<any> {\n  let contentType\n  try {\n    contentType = parse(req.headers['content-type'] || 'text/plain')\n  } catch {\n    contentType = parse('text/plain')\n  }\n  const { type, parameters } = contentType\n  const encoding = parameters.charset || 'utf-8'\n\n  let buffer\n\n  try {\n    buffer = await getRawBody(req, { encoding, limit })\n  } catch (e) {\n    if (e.type === 'entity.too.large') {\n      throw new ApiError(413, `Body exceeded ${limit} limit`)\n    } else {\n      throw new ApiError(400, 'Invalid body')\n    }\n  }\n\n  const body = buffer.toString()\n\n  if (type === 'application/json' || type === 'application/ld+json') {\n    return parseJson(body)\n  } else if (type === 'application/x-www-form-urlencoded') {\n    const qs = require('querystring')\n    return qs.decode(body)\n  } else {\n    return body\n  }\n}\n\n/**\n * Parse `JSON` and handles invalid `JSON` strings\n * @param str `JSON` string\n */\nfunction parseJson(str: string): object {\n  if (str.length === 0) {\n    // special-case empty json body, as it's a common client-side mistake\n    return {}\n  }\n\n  try {\n    return JSON.parse(str)\n  } catch (e) {\n    throw new ApiError(400, 'Invalid JSON')\n  }\n}\n\n/**\n * Parse cookies from the `headers` of request\n * @param req request object\n */\nexport function getCookieParser(headers: {\n  [key: string]: undefined | string | string[]\n}): () => NextApiRequestCookies {\n  return function parseCookie(): NextApiRequestCookies {\n    const header: undefined | string | string[] = headers.cookie\n\n    if (!header) {\n      return {}\n    }\n\n    const { parse: parseCookieFn } = require('next/dist/compiled/cookie')\n    return parseCookieFn(Array.isArray(header) ? header.join(';') : header)\n  }\n}\n\n/**\n *\n * @param res response object\n * @param statusCode `HTTP` status code of response\n */\nexport function sendStatusCode(\n  res: NextApiResponse,\n  statusCode: number\n): NextApiResponse<any> {\n  res.statusCode = statusCode\n  return res\n}\n\n/**\n *\n * @param res response object\n * @param [statusOrUrl] `HTTP` status code of redirect\n * @param url URL of redirect\n */\nexport function redirect(\n  res: NextApiResponse,\n  statusOrUrl: string | number,\n  url?: string\n): NextApiResponse<any> {\n  if (typeof statusOrUrl === 'string') {\n    url = statusOrUrl\n    statusOrUrl = 307\n  }\n  if (typeof statusOrUrl !== 'number' || typeof url !== 'string') {\n    throw new Error(\n      `Invalid redirect arguments. Please use a single argument URL, e.g. res.redirect('/destination') or use a status code and URL, e.g. res.redirect(307, '/destination').`\n    )\n  }\n  res.writeHead(statusOrUrl, { Location: url })\n  res.write(url)\n  res.end()\n  return res\n}\n\n/**\n * Send `any` body to response\n * @param req request object\n * @param res response object\n * @param body of response\n */\nexport function sendData(\n  req: NextApiRequest,\n  res: NextApiResponse,\n  body: any\n): void {\n  if (body === null || body === undefined) {\n    res.end()\n    return\n  }\n\n  // strip irrelevant headers/body\n  if (res.statusCode === 204 || res.statusCode === 304) {\n    res.removeHeader('Content-Type')\n    res.removeHeader('Content-Length')\n    res.removeHeader('Transfer-Encoding')\n\n    if (process.env.NODE_ENV === 'development' && body) {\n      console.warn(\n        `A body was attempted to be set with a 204 statusCode for ${req.url}, this is invalid and the body was ignored.\\n` +\n          `See more info here https://nextjs.org/docs/messages/invalid-api-status-body`\n      )\n    }\n    res.end()\n    return\n  }\n\n  const contentType = res.getHeader('Content-Type')\n\n  if (body instanceof Stream) {\n    if (!contentType) {\n      res.setHeader('Content-Type', 'application/octet-stream')\n    }\n    body.pipe(res)\n    return\n  }\n\n  const isJSONLike = ['object', 'number', 'boolean'].includes(typeof body)\n  const stringifiedBody = isJSONLike ? JSON.stringify(body) : body\n  const etag = generateETag(stringifiedBody)\n  if (sendEtagResponse(req, res, etag)) {\n    return\n  }\n\n  if (Buffer.isBuffer(body)) {\n    if (!contentType) {\n      res.setHeader('Content-Type', 'application/octet-stream')\n    }\n    res.setHeader('Content-Length', body.length)\n    res.end(body)\n    return\n  }\n\n  if (isJSONLike) {\n    res.setHeader('Content-Type', 'application/json; charset=utf-8')\n  }\n\n  res.setHeader('Content-Length', Buffer.byteLength(stringifiedBody))\n  res.end(stringifiedBody)\n}\n\n/**\n * Send `JSON` object\n * @param res response object\n * @param jsonBody of data\n */\nexport function sendJson(res: NextApiResponse, jsonBody: any): void {\n  // Set header to application/json\n  res.setHeader('Content-Type', 'application/json; charset=utf-8')\n\n  // Use send to handle request\n  res.send(jsonBody)\n}\n\nconst COOKIE_NAME_PRERENDER_BYPASS = `__prerender_bypass`\nconst COOKIE_NAME_PRERENDER_DATA = `__next_preview_data`\n\nexport const SYMBOL_PREVIEW_DATA = Symbol(COOKIE_NAME_PRERENDER_DATA)\nconst SYMBOL_CLEARED_COOKIES = Symbol(COOKIE_NAME_PRERENDER_BYPASS)\n\nexport function tryGetPreviewData(\n  req: IncomingMessage,\n  res: ServerResponse,\n  options: __ApiPreviewProps\n): PreviewData {\n  // Read cached preview data if present\n  if (SYMBOL_PREVIEW_DATA in req) {\n    return (req as any)[SYMBOL_PREVIEW_DATA] as any\n  }\n\n  const getCookies = getCookieParser(req.headers)\n  let cookies: NextApiRequestCookies\n  try {\n    cookies = getCookies()\n  } catch {\n    // TODO: warn\n    return false\n  }\n\n  const hasBypass = COOKIE_NAME_PRERENDER_BYPASS in cookies\n  const hasData = COOKIE_NAME_PRERENDER_DATA in cookies\n\n  // Case: neither cookie is set.\n  if (!(hasBypass || hasData)) {\n    return false\n  }\n\n  // Case: one cookie is set, but not the other.\n  if (hasBypass !== hasData) {\n    clearPreviewData(res as NextApiResponse)\n    return false\n  }\n\n  // Case: preview session is for an old build.\n  if (cookies[COOKIE_NAME_PRERENDER_BYPASS] !== options.previewModeId) {\n    clearPreviewData(res as NextApiResponse)\n    return false\n  }\n\n  const tokenPreviewData = cookies[COOKIE_NAME_PRERENDER_DATA]\n\n  const jsonwebtoken =\n    require('next/dist/compiled/jsonwebtoken') as typeof import('jsonwebtoken')\n  let encryptedPreviewData: {\n    data: string\n  }\n  try {\n    encryptedPreviewData = jsonwebtoken.verify(\n      tokenPreviewData,\n      options.previewModeSigningKey\n    ) as typeof encryptedPreviewData\n  } catch {\n    // TODO: warn\n    clearPreviewData(res as NextApiResponse)\n    return false\n  }\n\n  const decryptedPreviewData = decryptWithSecret(\n    Buffer.from(options.previewModeEncryptionKey),\n    encryptedPreviewData.data\n  )\n\n  try {\n    // TODO: strict runtime type checking\n    const data = JSON.parse(decryptedPreviewData)\n    // Cache lookup\n    Object.defineProperty(req, SYMBOL_PREVIEW_DATA, {\n      value: data,\n      enumerable: false,\n    })\n    return data\n  } catch {\n    return false\n  }\n}\n\nfunction isNotValidData(str: string): boolean {\n  return typeof str !== 'string' || str.length < 16\n}\n\nfunction setPreviewData<T>(\n  res: NextApiResponse<T>,\n  data: object | string, // TODO: strict runtime type checking\n  options: {\n    maxAge?: number\n  } & __ApiPreviewProps\n): NextApiResponse<T> {\n  if (isNotValidData(options.previewModeId)) {\n    throw new Error('invariant: invalid previewModeId')\n  }\n  if (isNotValidData(options.previewModeEncryptionKey)) {\n    throw new Error('invariant: invalid previewModeEncryptionKey')\n  }\n  if (isNotValidData(options.previewModeSigningKey)) {\n    throw new Error('invariant: invalid previewModeSigningKey')\n  }\n\n  const jsonwebtoken =\n    require('next/dist/compiled/jsonwebtoken') as typeof import('jsonwebtoken')\n\n  const payload = jsonwebtoken.sign(\n    {\n      data: encryptWithSecret(\n        Buffer.from(options.previewModeEncryptionKey),\n        JSON.stringify(data)\n      ),\n    },\n    options.previewModeSigningKey,\n    {\n      algorithm: 'HS256',\n      ...(options.maxAge !== undefined\n        ? { expiresIn: options.maxAge }\n        : undefined),\n    }\n  )\n\n  // limit preview mode cookie to 2KB since we shouldn't store too much\n  // data here and browsers drop cookies over 4KB\n  if (payload.length > 2048) {\n    throw new Error(\n      `Preview data is limited to 2KB currently, reduce how much data you are storing as preview data to continue`\n    )\n  }\n\n  const { serialize } =\n    require('next/dist/compiled/cookie') as typeof import('cookie')\n  const previous = res.getHeader('Set-Cookie')\n  res.setHeader(`Set-Cookie`, [\n    ...(typeof previous === 'string'\n      ? [previous]\n      : Array.isArray(previous)\n      ? previous\n      : []),\n    serialize(COOKIE_NAME_PRERENDER_BYPASS, options.previewModeId, {\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n      ...(options.maxAge !== undefined\n        ? ({ maxAge: options.maxAge } as CookieSerializeOptions)\n        : undefined),\n    }),\n    serialize(COOKIE_NAME_PRERENDER_DATA, payload, {\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n      ...(options.maxAge !== undefined\n        ? ({ maxAge: options.maxAge } as CookieSerializeOptions)\n        : undefined),\n    }),\n  ])\n  return res\n}\n\nfunction clearPreviewData<T>(res: NextApiResponse<T>): NextApiResponse<T> {\n  if (SYMBOL_CLEARED_COOKIES in res) {\n    return res\n  }\n\n  const { serialize } =\n    require('next/dist/compiled/cookie') as typeof import('cookie')\n  const previous = res.getHeader('Set-Cookie')\n  res.setHeader(`Set-Cookie`, [\n    ...(typeof previous === 'string'\n      ? [previous]\n      : Array.isArray(previous)\n      ? previous\n      : []),\n    serialize(COOKIE_NAME_PRERENDER_BYPASS, '', {\n      // To delete a cookie, set `expires` to a date in the past:\n      // https://tools.ietf.org/html/rfc6265#section-4.1.1\n      // `Max-Age: 0` is not valid, thus ignored, and the cookie is persisted.\n      expires: new Date(0),\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n    }),\n    serialize(COOKIE_NAME_PRERENDER_DATA, '', {\n      // To delete a cookie, set `expires` to a date in the past:\n      // https://tools.ietf.org/html/rfc6265#section-4.1.1\n      // `Max-Age: 0` is not valid, thus ignored, and the cookie is persisted.\n      expires: new Date(0),\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n    }),\n  ])\n\n  Object.defineProperty(res, SYMBOL_CLEARED_COOKIES, {\n    value: true,\n    enumerable: false,\n  })\n  return res\n}\n\n/**\n * Custom error class\n */\nexport class ApiError extends Error {\n  readonly statusCode: number\n\n  constructor(statusCode: number, message: string) {\n    super(message)\n    this.statusCode = statusCode\n  }\n}\n\n/**\n * Sends error in `response`\n * @param res response object\n * @param statusCode of response\n * @param message of response\n */\nexport function sendError(\n  res: NextApiResponse,\n  statusCode: number,\n  message: string\n): void {\n  res.statusCode = statusCode\n  res.statusMessage = message\n  res.end(message)\n}\n\ninterface LazyProps {\n  req: NextApiRequest\n}\n\n/**\n * Execute getter function only if its needed\n * @param LazyProps `req` and `params` for lazyProp\n * @param prop name of property\n * @param getter function to get data\n */\nexport function setLazyProp<T>(\n  { req }: LazyProps,\n  prop: string,\n  getter: () => T\n): void {\n  const opts = { configurable: true, enumerable: true }\n  const optsReset = { ...opts, writable: true }\n\n  Object.defineProperty(req, prop, {\n    ...opts,\n    get: () => {\n      const value = getter()\n      // we set the property on the object to avoid recalculating it\n      Object.defineProperty(req, prop, { ...optsReset, value })\n      return value\n    },\n    set: (value) => {\n      Object.defineProperty(req, prop, { ...optsReset, value })\n    },\n  })\n}\n"],"names":[],"mappings":"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"}