{"version":3,"sources":["../../../server/dev/hot-middleware.ts"],"sourcesContent":["// Based on https://github.com/webpack-contrib/webpack-hot-middleware/blob/9708d781ae0e46179cf8ea1a94719de4679aaf53/middleware.js\n// Included License below\n\n// Copyright JS Foundation and other contributors\n\n// Permission is hereby granted, free of charge, to any person obtaining\n// a copy of this software and associated documentation files (the\n// 'Software'), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to\n// permit persons to whom the Software is furnished to do so, subject to\n// the following conditions:\n\n// The above copyright notice and this permission notice shall be\n// included in all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,\n// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\n// IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY\n// CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\n// TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n// SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\nimport { webpack } from 'next/dist/compiled/webpack/webpack'\nimport http from 'http'\n\nexport class WebpackHotMiddleware {\n  eventStream: EventStream\n  latestStats: webpack.Stats | null\n  clientLatestStats: webpack.Stats | null\n  closed: boolean\n  serverError: boolean\n\n  constructor(compilers: webpack.Compiler[]) {\n    this.eventStream = new EventStream()\n    this.latestStats = null\n    this.clientLatestStats = null\n    this.serverError = false\n    this.closed = false\n\n    compilers[0].hooks.invalid.tap(\n      'webpack-hot-middleware',\n      this.onClientInvalid\n    )\n    compilers[0].hooks.done.tap('webpack-hot-middleware', this.onClientDone)\n\n    compilers[1].hooks.invalid.tap(\n      'webpack-hot-middleware',\n      this.onServerInvalid\n    )\n    compilers[1].hooks.done.tap('webpack-hot-middleware', this.onServerDone)\n  }\n\n  onServerInvalid = () => {\n    if (!this.serverError) return\n\n    this.serverError = false\n\n    if (this.clientLatestStats) {\n      this.latestStats = this.clientLatestStats\n      this.publishStats('built', this.latestStats)\n    }\n  }\n  onClientInvalid = () => {\n    if (this.closed || this.serverError) return\n    this.latestStats = null\n    this.eventStream.publish({ action: 'building' })\n  }\n  onServerDone = (statsResult: webpack.Stats) => {\n    if (this.closed) return\n    // Keep hold of latest stats so they can be propagated to new clients\n    // this.latestStats = statsResult\n    // this.publishStats('built', this.latestStats)\n    this.serverError = statsResult.hasErrors()\n\n    if (this.serverError) {\n      this.latestStats = statsResult\n      this.publishStats('built', this.latestStats)\n    }\n  }\n  onClientDone = (statsResult: webpack.Stats) => {\n    this.clientLatestStats = statsResult\n\n    if (this.closed || this.serverError) return\n    // Keep hold of latest stats so they can be propagated to new clients\n    this.latestStats = statsResult\n    this.publishStats('built', this.latestStats)\n  }\n  middleware = (\n    req: http.IncomingMessage,\n    res: http.ServerResponse,\n    next: () => void\n  ) => {\n    if (this.closed) return next()\n    if (!req.url?.startsWith('/_next/webpack-hmr')) return next()\n    this.eventStream.handler(req, res)\n    if (this.latestStats) {\n      // Explicitly not passing in `log` fn as we don't want to log again on\n      // the server\n      this.publishStats('sync', this.latestStats)\n    }\n  }\n\n  publishStats = (action: string, statsResult: webpack.Stats) => {\n    const stats = statsResult.toJson({\n      all: false,\n      hash: true,\n      warnings: true,\n      errors: true,\n    })\n\n    this.eventStream.publish({\n      action: action,\n      hash: stats.hash,\n      warnings: stats.warnings || [],\n      errors: stats.errors || [],\n    })\n  }\n\n  publish = (payload: any) => {\n    if (this.closed) return\n    this.eventStream.publish(payload)\n  }\n  close = () => {\n    if (this.closed) return\n    // Can't remove compiler plugins, so we just set a flag and noop if closed\n    // https://github.com/webpack/tapable/issues/32#issuecomment-350644466\n    this.closed = true\n    this.eventStream.close()\n  }\n}\n\nclass EventStream {\n  clients: Set<http.ServerResponse>\n  interval: NodeJS.Timeout\n  constructor() {\n    this.clients = new Set()\n\n    this.interval = setInterval(this.heartbeatTick, 2500).unref()\n  }\n\n  heartbeatTick = () => {\n    this.everyClient((client) => {\n      client.write('data: \\uD83D\\uDC93\\n\\n')\n    })\n  }\n\n  everyClient(fn: (client: http.ServerResponse) => void) {\n    for (const client of this.clients) {\n      fn(client)\n    }\n  }\n\n  close() {\n    clearInterval(this.interval)\n    this.everyClient((client) => {\n      if (!client.finished) client.end()\n    })\n    this.clients.clear()\n  }\n\n  handler(req: http.IncomingMessage, res: http.ServerResponse) {\n    const headers = {\n      'Access-Control-Allow-Origin': '*',\n      'Content-Type': 'text/event-stream;charset=utf-8',\n      'Cache-Control': 'no-cache, no-transform',\n      // While behind nginx, event stream should not be buffered:\n      // http://nginx.org/docs/http/ngx_http_proxy_module.html#proxy_buffering\n      'X-Accel-Buffering': 'no',\n    }\n\n    const isHttp1 = !(parseInt(req.httpVersion) >= 2)\n    if (isHttp1) {\n      req.socket.setKeepAlive(true)\n      Object.assign(headers, {\n        Connection: 'keep-alive',\n      })\n    }\n\n    res.writeHead(200, headers)\n    res.write('\\n')\n    this.clients.add(res)\n    req.on('close', () => {\n      if (!res.finished) res.end()\n      this.clients.delete(res)\n    })\n  }\n\n  publish(payload: any) {\n    this.everyClient((client) => {\n      client.write('data: ' + JSON.stringify(payload) + '\\n\\n')\n    })\n  }\n}\n"],"names":[],"mappings":"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"}