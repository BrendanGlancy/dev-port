{"version":3,"sources":["../../server/crypto-utils.ts"],"sourcesContent":["import crypto from 'crypto'\n\n// Background:\n// https://security.stackexchange.com/questions/184305/why-would-i-ever-use-aes-256-cbc-if-aes-256-gcm-is-more-secure\n\nconst CIPHER_ALGORITHM = `aes-256-gcm`,\n  CIPHER_KEY_LENGTH = 32, // https://stackoverflow.com/a/28307668/4397028\n  CIPHER_IV_LENGTH = 16, // https://stackoverflow.com/a/28307668/4397028\n  CIPHER_TAG_LENGTH = 16,\n  CIPHER_SALT_LENGTH = 64\n\nconst PBKDF2_ITERATIONS = 100_000 // https://support.1password.com/pbkdf2/\n\nexport function encryptWithSecret(secret: Buffer, data: string): string {\n  const iv = crypto.randomBytes(CIPHER_IV_LENGTH)\n  const salt = crypto.randomBytes(CIPHER_SALT_LENGTH)\n\n  // https://nodejs.org/api/crypto.html#crypto_crypto_pbkdf2sync_password_salt_iterations_keylen_digest\n  const key = crypto.pbkdf2Sync(\n    secret,\n    salt,\n    PBKDF2_ITERATIONS,\n    CIPHER_KEY_LENGTH,\n    `sha512`\n  )\n\n  const cipher = crypto.createCipheriv(CIPHER_ALGORITHM, key, iv)\n  const encrypted = Buffer.concat([cipher.update(data, `utf8`), cipher.final()])\n\n  // https://nodejs.org/api/crypto.html#crypto_cipher_getauthtag\n  const tag = cipher.getAuthTag()\n\n  return Buffer.concat([\n    // Data as required by:\n    // Salt for Key: https://nodejs.org/api/crypto.html#crypto_crypto_pbkdf2sync_password_salt_iterations_keylen_digest\n    // IV: https://nodejs.org/api/crypto.html#crypto_class_decipher\n    // Tag: https://nodejs.org/api/crypto.html#crypto_decipher_setauthtag_buffer\n    salt,\n    iv,\n    tag,\n    encrypted,\n  ]).toString(`hex`)\n}\n\nexport function decryptWithSecret(\n  secret: Buffer,\n  encryptedData: string\n): string {\n  const buffer = Buffer.from(encryptedData, `hex`)\n\n  const salt = buffer.slice(0, CIPHER_SALT_LENGTH)\n  const iv = buffer.slice(\n    CIPHER_SALT_LENGTH,\n    CIPHER_SALT_LENGTH + CIPHER_IV_LENGTH\n  )\n  const tag = buffer.slice(\n    CIPHER_SALT_LENGTH + CIPHER_IV_LENGTH,\n    CIPHER_SALT_LENGTH + CIPHER_IV_LENGTH + CIPHER_TAG_LENGTH\n  )\n  const encrypted = buffer.slice(\n    CIPHER_SALT_LENGTH + CIPHER_IV_LENGTH + CIPHER_TAG_LENGTH\n  )\n\n  // https://nodejs.org/api/crypto.html#crypto_crypto_pbkdf2sync_password_salt_iterations_keylen_digest\n  const key = crypto.pbkdf2Sync(\n    secret,\n    salt,\n    PBKDF2_ITERATIONS,\n    CIPHER_KEY_LENGTH,\n    `sha512`\n  )\n\n  const decipher = crypto.createDecipheriv(CIPHER_ALGORITHM, key, iv)\n  decipher.setAuthTag(tag)\n\n  return decipher.update(encrypted) + decipher.final(`utf8`)\n}\n"],"names":[],"mappings":";;;;QAagB,iBAAiB,GAAjB,iBAAiB;QA+BjB,iBAAiB,GAAjB,iBAAiB;AA5Cd,GAAQ,CAAR,OAAQ;;;;;;AAE3B,EAAc,AAAd,YAAc;AACd,EAAqH,AAArH,mHAAqH;AAErH,KAAK,CAAC,gBAAgB,IAAI,WAAW,GACnC,iBAAiB,GAAG,EAAE,EACtB,gBAAgB,GAAG,EAAE,EACrB,iBAAiB,GAAG,EAAE,EACtB,kBAAkB,GAAG,EAAE;AAEzB,KAAK,CAAC,iBAAiB,GAAG,MAAO,AAAC,CAAwC,AAAxC,EAAwC,AAAxC,sCAAwC;;SAE1D,iBAAiB,CAAC,MAAc,EAAE,IAAY,EAAU,CAAC;IACvE,KAAK,CAAC,EAAE,GAdS,OAAQ,SAcP,WAAW,CAAC,gBAAgB;IAC9C,KAAK,CAAC,IAAI,GAfO,OAAQ,SAeL,WAAW,CAAC,kBAAkB;IAElD,EAAqG,AAArG,mGAAqG;IACrG,KAAK,CAAC,GAAG,GAlBQ,OAAQ,SAkBN,UAAU,CAC3B,MAAM,EACN,IAAI,EACJ,iBAAiB,EACjB,iBAAiB,GAChB,MAAM;IAGT,KAAK,CAAC,MAAM,GA1BK,OAAQ,SA0BH,cAAc,CAAC,gBAAgB,EAAE,GAAG,EAAE,EAAE;IAC9D,KAAK,CAAC,SAAS,GAAG,MAAM,CAAC,MAAM;QAAE,MAAM,CAAC,MAAM,CAAC,IAAI,GAAG,IAAI;QAAI,MAAM,CAAC,KAAK;;IAE1E,EAA8D,AAA9D,4DAA8D;IAC9D,KAAK,CAAC,GAAG,GAAG,MAAM,CAAC,UAAU;WAEtB,MAAM,CAAC,MAAM;QAClB,EAAuB,AAAvB,qBAAuB;QACvB,EAAmH,AAAnH,iHAAmH;QACnH,EAA+D,AAA/D,6DAA+D;QAC/D,EAA4E,AAA5E,0EAA4E;QAC5E,IAAI;QACJ,EAAE;QACF,GAAG;QACH,SAAS;OACR,QAAQ,EAAE,GAAG;AAClB,CAAC;SAEe,iBAAiB,CAC/B,MAAc,EACd,aAAqB,EACb,CAAC;IACT,KAAK,CAAC,MAAM,GAAG,MAAM,CAAC,IAAI,CAAC,aAAa,GAAG,GAAG;IAE9C,KAAK,CAAC,IAAI,GAAG,MAAM,CAAC,KAAK,CAAC,CAAC,EAAE,kBAAkB;IAC/C,KAAK,CAAC,EAAE,GAAG,MAAM,CAAC,KAAK,CACrB,kBAAkB,EAClB,kBAAkB,GAAG,gBAAgB;IAEvC,KAAK,CAAC,GAAG,GAAG,MAAM,CAAC,KAAK,CACtB,kBAAkB,GAAG,gBAAgB,EACrC,kBAAkB,GAAG,gBAAgB,GAAG,iBAAiB;IAE3D,KAAK,CAAC,SAAS,GAAG,MAAM,CAAC,KAAK,CAC5B,kBAAkB,GAAG,gBAAgB,GAAG,iBAAiB;IAG3D,EAAqG,AAArG,mGAAqG;IACrG,KAAK,CAAC,GAAG,GAhEQ,OAAQ,SAgEN,UAAU,CAC3B,MAAM,EACN,IAAI,EACJ,iBAAiB,EACjB,iBAAiB,GAChB,MAAM;IAGT,KAAK,CAAC,QAAQ,GAxEG,OAAQ,SAwED,gBAAgB,CAAC,gBAAgB,EAAE,GAAG,EAAE,EAAE;IAClE,QAAQ,CAAC,UAAU,CAAC,GAAG;WAEhB,QAAQ,CAAC,MAAM,CAAC,SAAS,IAAI,QAAQ,CAAC,KAAK,EAAE,IAAI;AAC1D,CAAC"}